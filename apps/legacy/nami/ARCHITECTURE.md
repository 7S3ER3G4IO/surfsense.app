# Architecture & Protocol Definition

## 1. System Architecture (Hybrid Local WebSocket)

The system consists of two main components running on the local machine:
1.  **Host (Electron App)**: Acts as the "Server" and "Controller". It runs a secure local WebSocket server.
2.  **Client (Chrome Extension)**: Acts as the "Worker". It connects to the Host via WebSocket to receive tasks and report status.

### Why WebSocket (Option A)?
-   **Stability**: Persistent connection allows real-time state sync without polling.
-   **Bi-directional**: Server can push tasks immediately; Client can stream logs/events.
-   **Flexibility**: Easier to debug via standard tools than Native Messaging stdio pipes.
-   **Permissions**: Less invasive installation (no system-wide manifest registration required).

## 2. Communication Protocol (JSON over WS)

All messages are JSON objects.

### Envelope Structure
```json
{
  "id": "uuid-v4",          // Unique Message ID (for Ack/Response)
  "type": "CATEGORY:ACTION", // e.g., "AUTH:HELLO", "TASK:EXECUTE"
  "payload": {},             // Data specific to the action
  "meta": {                  // Optional metadata
    "timestamp": 1234567890,
    "retryCount": 0
  }
}
```

### Core Message Types

#### A. Handshake (Auth)
1.  **Client -> Host**: `AUTH:HELLO`
    *   Payload: `{ "version": "1.2.0", "userAgent": "Chrome/..." }`
2.  **Host -> Client**: `AUTH:WELCOME` (if accepted)
    *   Payload: `{ "serverVersion": "1.5.0", "config": { "pollInterval": 5000 } }`
    *   *Or `AUTH:REJECT` if version mismatch.*

#### B. Heartbeat (Health)
*   **Host -> Client**: `SYS:PING`
*   **Client -> Host**: `SYS:PONG` (Payload: `{ "status": "idle|busy", "battery": "ok" }`)

#### C. Task Execution
1.  **Host -> Client**: `TASK:EXECUTE`
    *   Payload: `{ "taskId": "t1", "action": "NAVIGATE", "params": { "url": "..." } }`
2.  **Client -> Host**: `TASK:ACK` (Immediate receipt confirmation)
3.  **Client -> Host**: `TASK:UPDATE` (Progress updates)
4.  **Client -> Host**: `TASK:RESULT` (Final outcome)
    *   Payload: `{ "taskId": "t1", "success": true, "data": {} }`

#### D. Logs
*   **Client -> Host**: `LOG:ENTRY`
    *   Payload: `{ "level": "info|warn|error", "message": "...", "context": {} }`

## 3. Reliability Mechanisms

1.  **Auto-Reconnect**: Client attempts reconnection every 2s, 5s, 10s (exponential backoff) if connection is lost.
2.  **Queueing**: If offline, Client queues `TASK:RESULT` and `LOG:ENTRY` messages in `chrome.storage.local` and flushes them upon reconnection.
3.  **Keep-Alive**: Host sends `SYS:PING` every 30s. If no `PONG` within 10s, Host marks Client as "Disconnected".
4.  **Idempotency**: Host tracks `taskId`. If Client sends duplicate `TASK:RESULT` (due to network blip), Host ignores the second one.

## 4. Security

1.  **Localhost Only**: Server binds strictly to `127.0.0.1`.
2.  **Token Handshake (Optional)**: Can implement a shared secret generated by App and saved to Extension via File System (Native Messaging) or Manual Copy (MVP). *For this version, we assume Localhost trust is sufficient for MVP, but architecture supports adding an `authToken` field to `AUTH:HELLO`.*

## 5. Directory Structure

```
nami/
├── main.js                  # Electron Main Process (Host)
├── preload.cjs              # Secure Bridge
├── server/
│   └── WSServer.js          # NEW: Robust WebSocket Server Logic
├── extension/
│   ├── manifest.json
│   ├── background.js        # Service Worker (Client Logic)
│   └── lib/
│       └── NamiClient.js    # NEW: Robust WS Client Class
├── ui/
│   ├── index.html           # Dashboard Entry
│   ├── css/
│   │   ├── theme.css        # NEW: Dark Premium Theme
│   │   └── components.css
│   └── js/
│       ├── router.js        # NEW: Page Navigation
│       └── views/           # View Logic
```
