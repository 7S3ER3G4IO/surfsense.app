datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum SocialProvider {
  YOUTUBE
  TIKTOK
  INSTAGRAM
}

enum MediaType {
  IMAGE
  VIDEO
}

enum MediaSource {
  UPLOAD
  DRIVE
  DROPBOX
}

enum MediaRights {
  OWNED
  LICENSED
  PUBLIC_DOMAIN
}

enum ContentStyle {
  MINIMAL
  NEON
  CORPORATE
}

enum ContentObjective {
  TRAFFIC
  AWARENESS
  CONVERSION
}

enum PlanStatus {
  DRAFT
  GENERATED
  APPROVED
  REJECTED
}

enum RenderStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PostStatus {
  QUEUED
  PUBLISHED
  FAILED
}

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaces WorkspaceMember[]
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  WorkspaceMember[]
  projects Project[]
}

model WorkspaceMember {
  id          String   @id @default(uuid())
  userId      String
  workspaceId String
  role        String   @default("MEMBER") // OWNER, MEMBER
  createdAt   DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

model Project {
  id          String   @id @default(uuid())
  name        String
  workspaceId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace      Workspace        @relation(fields: [workspaceId], references: [id])
  socialAccounts SocialAccount[]
  mediaAssets    MediaAsset[]
  autopilotRules AutopilotRule?
  contentPlans   ContentPlan[]
  posts          Post[]
}

model SocialAccount {
  id               String         @id @default(uuid())
  projectId        String
  provider         SocialProvider
  accountId        String
  displayName      String
  scopes           String[]
  tokenEncrypted   String
  refreshEncrypted String?
  expiresAt        DateTime?
  status           String         @default("ACTIVE") // ACTIVE, EXPIRED, REVOKED
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  project Project @relation(fields: [projectId], references: [id])
  posts   Post[]
}

model MediaAsset {
  id        String      @id @default(uuid())
  projectId String
  source    MediaSource
  s3Key     String
  type      MediaType
  duration  Float?      // in seconds
  width     Int?
  height    Int?
  fps       Float?
  hash      String?
  tags      Json?       // array of strings
  rights    MediaRights @default(OWNED)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  project Project @relation(fields: [projectId], references: [id])
}

model AutopilotRule {
  id          String           @id @default(uuid())
  projectId   String           @unique
  cadence     String           // e.g., "1_per_day", "3_per_week"
  windows     Json?            // e.g., ["12:00-14:00", "18:00-21:00"]
  language    String           @default("en")
  style       ContentStyle     @default(MINIMAL)
  objective   ContentObjective @default(AWARENESS)
  enabled     Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  project Project @relation(fields: [projectId], references: [id])
}

model ContentPlan {
  id        String     @id @default(uuid())
  projectId String
  createdBy String?    // user id or "SYSTEM"
  planJson  Json       // Detailed plan structure
  status    PlanStatus @default(DRAFT)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  project Project  @relation(fields: [projectId], references: [id])
  renders Render[]
}

model Render {
  id            String       @id @default(uuid())
  contentPlanId String
  outputS3Key   String?
  duration      Float?
  format        String       @default("mp4")
  status        RenderStatus @default(PENDING)
  logs          Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  contentPlan ContentPlan @relation(fields: [contentPlanId], references: [id])
  posts       Post[]
}

model Post {
  id              String         @id @default(uuid())
  projectId       String
  socialAccountId String
  renderId        String
  title           String?
  description     String?
  hashtags        String[]
  scheduledFor    DateTime?
  publishedAt     DateTime?
  providerPostId  String?
  status          PostStatus     @default(QUEUED)
  error           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  project       Project          @relation(fields: [projectId], references: [id])
  socialAccount SocialAccount    @relation(fields: [socialAccountId], references: [id])
  render        Render           @relation(fields: [renderId], references: [id])
  analytics     AnalyticsDaily[]
}

model AnalyticsDaily {
  id        String   @id @default(uuid())
  postId    String
  date      DateTime @default(now()) @db.Date
  views     Int      @default(0)
  watchTime Float    @default(0)
  likes     Int      @default(0)
  comments  Int      @default(0)
  shares    Int      @default(0)
  clicks    Int      @default(0)
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])

  @@unique([postId, date])
}
