<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — Surveillance</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" href="../logo.svg" type="image/svg+xml" />
    <style>
      .admin-layout{display:flex;min-height:100vh}
      .admin-sidebar{width:260px;background:#0b0e16;border-right:1px solid #1f2937;padding:18px;position:sticky;top:0;height:100vh;backdrop-filter:blur(8px)}
      .admin-brand{display:flex;align-items:center;gap:10px;color:#e5e7eb;font-weight:800;margin-bottom:18px}
      .admin-nav a{display:block;padding:10px 12px;border-radius:12px;color:#c4b5fd;text-decoration:none;margin-bottom:6px;transition:background .2s, transform .1s}
      .admin-nav a:hover{background:#111827;transform:translateX(2px)}
      .admin-main{flex:1;padding:24px;background:
        radial-gradient(1200px 600px at -10% -10%, rgba(124,58,237,.12), transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, rgba(34,197,94,.12), transparent 60%)}
      .admin-card{background:rgba(11,14,22,.7);backdrop-filter:blur(8px);border:1px solid #1f2937;border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
      .metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
      .metric-label{color:#94a3b8;font-weight:700}
      .metric-value{color:#e5e7eb;font-weight:900}
    </style>
  </head>
  <body style="background:#080a12;">
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div class="admin-brand">
          <img src="../logo.svg" alt="logo" width="24" height="24"/>
          <span>Admin</span>
        </div>
        <nav class="admin-nav">
          <a href="/admin/">Dashboard</a>
          <a href="/admin/surveillance.html">Surveillance</a>
          <a href="/admin/marketing.html">Réseaux</a>
        </nav>
      </aside>
      <main class="admin-main">
        <div class="section" style="max-width:1000px; margin:0 auto;">
          <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <h2>Surveillance Système</h2>
              <p style="color:#94a3b8;">Santé et états en temps réel</p>
            </div>
            <div>
              <button id="btn-refresh" class="btn btn--compact">Rafraîchir</button>
            </div>
          </div>
          <div class="admin-card">
            <div class="metric-grid">
              <div class="metric-label">DB</div><div id="health-db" class="metric-value">-</div>
              <div class="metric-label">Ping DB</div><div id="health-ping" class="metric-value">-</div>
              <div class="metric-label">Uptime</div><div id="health-uptime" class="metric-value">-</div>
              <div class="metric-label">Mémoire</div><div id="health-mem" class="metric-value">-</div>
              <div class="metric-label">Cache Items</div><div id="health-cache" class="metric-value">-</div>
              <div class="metric-label">APIs (24h)</div><div id="health-api" class="metric-value">-</div>
              <div class="metric-label">Spots</div><div id="health-spots" class="metric-value">-</div>
              <div class="metric-label">Quota LIMITE</div><div id="health-limit" class="metric-value">-</div>
              <div class="metric-label">Quota RESTANT</div><div id="health-rem" class="metric-value">-</div>
              <div class="metric-label">Quota UTILISÉ</div><div id="health-used" class="metric-value">-</div>
              <div class="metric-label">Worker</div><div id="worker-state" class="metric-value">-</div>
              <div class="metric-label">Interval worker</div><div id="worker-interval-cur" class="metric-value">-</div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script>
      (function(){
        const params = new URLSearchParams(window.location.search);
        const tParam = params.get("token");
        if (tParam) { try { localStorage.setItem("surfAdminToken", tParam); history.replaceState({}, "", window.location.pathname); } catch {} }
        const tok = localStorage.getItem("surfAdminToken") || "";
        const headers = tok ? { "x-admin-token": tok } : {};
        const q = (id) => document.getElementById(id);
        async function loadHealth() {
          try {
            const r = await fetch("/api/admin/health", { headers });
            const h = await r.json();
            q("health-db").textContent = h.db ? "OK" : "ERREUR";
            q("health-ping").textContent = (h.pingMs ?? "-")+" ms";
            q("health-uptime").textContent = h.uptime+" s";
            q("health-mem").textContent = h.memoryMB+" MB";
            q("health-cache").textContent = h.cacheCount ?? "-";
            q("health-api").textContent = (h.apiCallCount ?? 0)+" appels";
            q("health-spots").textContent = "LIVE "+(h.live||0)+" · WAIT "+(h.wait||0);
            q("health-limit").textContent = h.quota?.limit ?? "-";
            q("health-rem").textContent = h.quota?.remaining ?? "-";
            q("health-used").textContent = h.quota?.used ?? "-";
            q("worker-interval-cur").textContent = h.worker?.intervalMinutes ?? "-";
            q("worker-state").textContent = h.worker?.paused ? "PAUSED" : "RUNNING";
          } catch (e) {
            alert("Accès refusé. Veuillez vous reconnecter.");
            localStorage.removeItem("surfAdminToken");
            window.location.href = "../index.html";
          }
        }
        document.getElementById("btn-refresh").onclick = loadHealth;
        loadHealth();
      })();
    </script>
  </body>
</html>
