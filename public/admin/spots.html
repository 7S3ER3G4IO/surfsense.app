<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — Spots</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" href="../logo.svg" type="image/svg+xml" />
    <style>
      .admin-layout{display:flex;min-height:100vh}
      .admin-sidebar{width:260px;background:#0b0e16;border-right:1px solid #1f2937;padding:18px;position:sticky;top:0;height:100vh;backdrop-filter:blur(8px)}
      .admin-brand{display:flex;align-items:center;gap:10px;color:#e5e7eb;font-weight:800;margin-bottom:18px}
      .admin-nav a{display:block;padding:10px 12px;border-radius:12px;color:#c4b5fd;text-decoration:none;margin-bottom:6px;transition:background .2s, transform .1s}
      .admin-nav a:hover{background:#111827;transform:translateX(2px)}
      .admin-main{flex:1;padding:24px;background:
        radial-gradient(1200px 600px at -10% -10%, rgba(124,58,237,.12), transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, rgba(34,197,94,.12), transparent 60%)}
      .admin-card{background:rgba(11,14,22,.7);backdrop-filter:blur(8px);border:1px solid #1f2937;border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
      .table{width:100%; border-collapse:collapse}
      .table th,.table td{border:1px solid #1f2937; padding:8px; color:#e5e7eb}
      .table th{color:#94a3b8; text-align:left}
    </style>
  </head>
  <body style="background:#080a12;">
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div class="admin-brand">
          <img src="../logo.svg" alt="logo" width="24" height="24"/>
          <span>Admin</span>
        </div>
        <nav class="admin-nav" id="admin-nav"></nav>
      </aside>
      <main class="admin-main">
        <div class="section" style="max-width:1200px; margin:0 auto;">
          <div class="section-title">
            <h2>Spots</h2>
            <p style="color:#94a3b8;">Etat live et actions</p>
          </div>
          <div class="admin-card">
            <table class="table">
              <thead><tr><th>Spot</th><th>Région</th><th>Statut</th><th>Actions</th></tr></thead>
              <tbody id="spots-body"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
    <script>
      (function(){
        fetch("/admin/nav.html").then(r=>r.text()).then(html=>{ const el=document.getElementById("admin-nav"); if(el) el.innerHTML=html; }).catch(()=>{});
        const params = new URLSearchParams(window.location.search);
        const tParam = params.get("token");
        if (tParam) { try { localStorage.setItem("surfAdminToken", tParam); history.replaceState({}, "", window.location.pathname); } catch {} }
        const tok = localStorage.getItem("surfAdminToken") || "";
        const headers = tok ? { "x-admin-token": tok, "Content-Type":"application/json" } : { "Content-Type":"application/json" };
        const q = (id) => document.getElementById(id);
        async function loadSpots() {
          try {
            const r = await fetch("/api/admin/spots", { headers: { "x-admin-token": tok } });
            const arr = await r.json();
            q("spots-body").innerHTML = arr.map(s => `
              <tr>
                <td>${s.name}</td>
                <td>${s.region}</td>
                <td>${s.status}</td>
                <td>
                  <button data-act="refresh" data-name="${s.name}" class="btn btn--compact">Refresh</button>
                  <button data-act="clear" data-name="${s.name}" class="btn btn--compact">Clear</button>
                  <button data-act="priority" data-name="${s.name}" class="btn btn--compact">Priorité</button>
                </td>
              </tr>
            `).join("");
          } catch {
            alert("Accès refusé.");
            localStorage.removeItem("surfAdminToken");
            window.location.href = "../index.html";
          }
        }
        document.addEventListener("click", async (e) => {
          const b = e.target.closest("button");
          if (!b) return;
          const name = b.getAttribute("data-name");
          const act = b.getAttribute("data-act");
          if (!name || !act) return;
          if (act === "refresh") await fetch("/api/admin/spots/refresh", { method:"POST", headers, body: JSON.stringify({ name }) });
          if (act === "clear") await fetch("/api/admin/spots/clear", { method:"POST", headers, body: JSON.stringify({ name }) });
          if (act === "priority") await fetch("/api/admin/spots/priority/toggle", { method:"POST", headers, body: JSON.stringify({ name }) });
          loadSpots();
        });
        loadSpots();
      })();
    </script>
  </body>
</html>
