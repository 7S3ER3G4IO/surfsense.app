<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwellSync ‚Äî Marketing Center</title>
    <link rel="icon" href="../logo.svg" type="image/svg+xml" />
    <style>
      :root {
        --bg-dark: #0f172a;
        --card-bg: #1e293b;
        --accent: #8b5cf6;
        --accent-hover: #7c3aed;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --border-color: #334155;
        --success: #22c55e;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
      }

      body {
        background-color: var(--bg-dark);
        color: var(--text-primary);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        margin: 0;
        height: 100vh;
        overflow: hidden;
      }

      .admin-container {
        display: grid;
        grid-template-columns: 260px 1fr;
        height: 100vh;
      }

      /* Sidebar styles are loaded from nav.html */
      .admin-sidebar {
        background: #0b0f19;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
      }

      .main-content {
        overflow-y: auto;
        padding: 32px;
        background: radial-gradient(circle at top right, rgba(139, 92, 246, 0.05), transparent 40%);
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
      }

      .page-title h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .page-title p {
        margin: 8px 0 0 0;
        color: var(--text-secondary);
        font-size: 14px;
      }

      .badge-pro {
        background: linear-gradient(135deg, var(--accent), #d946ef);
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        padding-bottom: 16px;
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
      .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
      .grid-auto { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }

      .form-group { margin-bottom: 16px; }
      .form-group label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .input-premium {
        width: 100%;
        background: #0f172a;
        border: 1px solid var(--border-color);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
        transition: all 0.2s;
      }
      .input-premium:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
      }
      
      textarea.input-premium { resize: vertical; min-height: 100px; font-family: inherit; }

      .btn {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn:hover { background: #2d3b4e; transform: translateY(-1px); }
      .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
      .btn-primary:hover { background: var(--accent-hover); }
      .btn-success { background: var(--success); border-color: var(--success); color: #000; }
      .btn-danger { background: var(--danger); border-color: var(--danger); color: white; }

      /* Network Cards */
      .net-card {
        background: #0f172a;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s;
        position: relative;
      }
      .net-card:hover { border-color: var(--accent); }
      .net-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
      .net-title { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 8px; }
      
      /* Switch */
      .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 24px; }
      .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: var(--accent); }
      input:checked + .slider:before { transform: translateX(20px); }

      .status-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 12px;
        background: #334155;
        color: #94a3b8;
        display: none;
      }
      .status-badge.active { display: inline-block; background: rgba(34, 197, 94, 0.2); color: var(--success); }
      .status-badge.missing { display: inline-block; background: rgba(239, 68, 68, 0.2); color: var(--danger); }

      .collapsible {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .collapsible.open { max-height: 500px; }
      .details-trigger {
        font-size: 11px;
        color: var(--accent);
        cursor: pointer;
        margin-top: 8px;
        display: inline-block;
      }

      /* Modal */
      .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 1000;
        display: none; justify-content: center; align-items: center;
      }
      .modal-content {
        background: var(--card-bg);
        padding: 32px;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        border: 1px solid var(--border-color);
        max-height: 90vh;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <aside class="admin-sidebar">
        <div style="padding: 24px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border-color);">
          <img src="../logo.svg" alt="logo" width="28" height="28"/>
          <span style="font-weight: 800; font-size: 18px; letter-spacing: -0.5px;">Admin Panel</span>
        </div>
        <nav id="admin-nav" style="flex: 1; padding: 16px; overflow-y: auto;"></nav>
      </aside>
      
      <main class="main-content">
        <div class="header">
          <div class="page-title">
            <h1>Marketing Center <span class="badge-pro">Premium</span></h1>
            <p>G√©rez votre pr√©sence multi-canal, vos automatisations et vos identit√©s.</p>
          </div>
          <div></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">üöÄ Actions Rapides</div>
          </div>
          <div class="grid-3">
            <div>
              <div style="font-size:12px; color:var(--text-secondary); margin-bottom:8px;">Publication</div>
              <div style="display:flex; flex-wrap:wrap; gap:8px;">
                <button id="mk-fire" class="btn btn-primary" title="Publier sur les r√©seaux activ√©s">‚ö° Publier Maintenant</button>
                <button id="mk-post-all" class="btn btn-primary" title="Choisir les r√©seaux √† publier">ÔøΩ Publier Tous</button>
                <button id="mk-publish-igtok" class="btn btn-primary" title="Publier un montage vid√©o en Reels + TikTok">üéûÔ∏è Reels + TikTok</button>
              </div>
            </div>
            <div>
              <div style="font-size:12px; color:var(--text-secondary); margin-bottom:8px;">Robot</div>
              <div style="display:flex; flex-wrap:wrap; gap:8px;">
                <button id="mk-start" class="btn btn-success" title="D√©marrer la planification">‚ñ∂ D√©marrer</button>
                <button id="mk-stop" class="btn btn-danger" title="Arr√™ter la planification">‚èπ Arr√™ter</button>
                <button id="mk-repair-login" class="btn" title="R√©parer les connexions navigateur">üß≠ R√©parer Connexions</button>
              </div>
            </div>
            <div>
              <div style="font-size:12px; color:var(--text-secondary); margin-bottom:8px;">Outils</div>
              <div style="display:flex; flex-wrap:wrap; gap:8px;">
                <button id="mk-preview-pro" class="btn" title="G√©n√©rer un aper√ßu du montage pro">üé¨ Pr√©visualiser Montage</button>
                <button id="mk-videos" class="btn" title="Voir les vid√©os g√©n√©r√©es">üì¶ Vid√©os</button>
                <button id="mk-trends" class="btn" title="Lister les tendances">üìà Tendances</button>
                <button id="mk-publish-trend" class="btn" title="Publier une trend">üî• Publier Trend</button>
                <button id="mk-secrets" class="btn" title="Configurer les cl√©s (.env)">üîë Cl√©s</button>
                <button id="mk-anti-bot" class="btn" title="Conseils anti‚Äëd√©tection">üõ°Ô∏è Anti‚Äëd√©tection</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Bar -->
        <div style="display:flex; gap:16px; margin-bottom:24px; align-items:center; background: rgba(34,197,94,0.1); border:1px solid rgba(34,197,94,0.2); padding:12px 20px; border-radius:12px;">
           <div style="width:10px; height:10px; background:var(--success); border-radius:50%; box-shadow:0 0 10px var(--success);"></div>
           <span id="mk-status" style="font-weight:600; color:#4ade80;">Status: CHARGEMENT...</span>
           <div style="flex:1;"></div>
           <button id="btn-import-cookies" class="btn" style="padding:6px 12px; font-size:12px;">üç™ Importer Cookies</button>
        </div>

        <!-- Identity Manager -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">üé≠ Identity Manager (Profil Global)</div>
                <button id="btn-update-profile" class="btn btn-primary">üîÑ Mettre √† jour tous les profils</button>
            </div>
            <div class="grid-2" style="grid-template-columns: 1fr 2fr;">
                <div>
                    <div class="form-group">
                        <label>Photo de Profil (JPG/PNG)</label>
                        <input type="file" id="mk-profile-photo" class="input-premium" accept="image/*" />
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Bio / Description</label>
                        <textarea id="mk-profile-bio" class="input-premium" rows="2" placeholder="SwellSync: Pr√©visions surf temps r√©el üåä..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Channels Grid -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">üì° Canaux de Diffusion</div>
                <button id="mk-save" class="btn btn-primary">üíæ Sauvegarder Config</button>
            </div>
            
            <div class="grid-auto">
                <!-- Instagram -->
                <div class="net-card">
                    <div class="net-header">
                        <div class="net-title">üì∏ Instagram <span id="st-instagram" class="status-badge"></span></div>
                        <label class="switch"><input type="checkbox" id="mk-ch-instagram"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select id="mk-fmt-instagram" class="input-premium" style="padding:8px;">
                            <option value="story">Story (9:16)</option>
                            <option value="post">Post (4:5)</option>
                            <option value="square">Post Carr√© (1:1)</option>
                            <option value="reel">Reel (9:16)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="padding-top:12px;">
                            <div class="form-group">
                                <label>URL Profil</label>
                                <input id="mk-pf-instagram" class="input-premium" placeholder="https://instagram.com/..." style="font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label>Webhook (Optionnel)</label>
                                <input id="mk-wh-instagram" class="input-premium" placeholder="Laisser vide pour Mode Direct" style="font-size:12px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Facebook -->
                <div class="net-card">
                    <div class="net-header">
                        <div class="net-title">üìò Facebook <span id="st-facebook" class="status-badge"></span></div>
                        <label class="switch"><input type="checkbox" id="mk-ch-facebook"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select id="mk-fmt-facebook" class="input-premium" style="padding:8px;">
                            <option value="post">Post (4:5)</option>
                            <option value="square">Post Carr√© (1:1)</option>
                            <option value="story">Story (9:16)</option>
                            <option value="reel">Reel (9:16)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="padding-top:12px;">
                            <div class="form-group">
                                <label>URL Profil</label>
                                <input id="mk-pf-facebook" class="input-premium" placeholder="URL Profil" style="font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label>Webhook (Optionnel)</label>
                                <input id="mk-wh-facebook" class="input-premium" placeholder="Laisser vide pour Mode Direct" style="font-size:12px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TikTok -->
                <div class="net-card">
                    <div class="net-header">
                        <div class="net-title">üéµ TikTok <span id="st-tiktok" class="status-badge"></span></div>
                        <label class="switch"><input type="checkbox" id="mk-ch-tiktok"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select id="mk-fmt-tiktok" class="input-premium" style="padding:8px;">
                            <option value="video">Vid√©o (9:16)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="padding-top:12px;">
                            <div class="form-group">
                                <label>URL Profil</label>
                                <input id="mk-pf-tiktok" class="input-premium" placeholder="URL Profil" style="font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label>Webhook (Recommand√©)</label>
                                <input id="mk-wh-tiktok" class="input-premium" placeholder="Webhook URL" style="font-size:12px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Threads -->
                <div class="net-card">
                    <div class="net-header">
                        <div class="net-title">üßµ Threads</div>
                        <label class="switch"><input type="checkbox" id="mk-ch-threads"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select id="mk-fmt-threads" class="input-premium" style="padding:8px;">
                            <option value="text_image">Texte + Image</option>
                            <option value="text">Texte seul</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="padding-top:12px;">
                            <div class="form-group">
                                <label>URL Profil</label>
                                <input id="mk-pf-threads" class="input-premium" placeholder="URL Profil" style="font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label>Webhook (Optionnel)</label>
                                <input id="mk-wh-threads" class="input-premium" placeholder="Laisser vide pour Mode Direct" style="font-size:12px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- YouTube -->
                <div class="net-card">
                    <div class="net-header">
                        <div class="net-title">üì∫ YouTube <span id="st-youtube" class="status-badge"></span></div>
                        <label class="switch"><input type="checkbox" id="mk-ch-youtube"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select id="mk-fmt-youtube" class="input-premium" style="padding:8px;">
                            <option value="shorts">Shorts (9:16)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="padding-top:12px;">
                            <div class="form-group">
                                <label>URL Profil</label>
                                <input id="mk-pf-youtube" class="input-premium" placeholder="URL Profil" style="font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label>Webhook (Optionnel)</label>
                                <input id="mk-wh-youtube" class="input-premium" placeholder="Laisser vide pour Mode Direct" style="font-size:12px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Twitter -->
                <div class="net-card">
                    <div class="net-header">
                        <div class="net-title">‚úñÔ∏è X / Twitter <span id="st-twitter" class="status-badge"></span></div>
                        <label class="switch"><input type="checkbox" id="mk-ch-twitter"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select id="mk-fmt-twitter" class="input-premium" style="padding:8px;">
                            <option value="text_image">Texte + Image</option>
                            <option value="text">Texte seul</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="padding-top:12px;">
                            <div class="form-group">
                                <label>URL Profil</label>
                                <input id="mk-pf-twitter" class="input-premium" placeholder="URL Profil" style="font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label>Webhook (Optionnel)</label>
                                <input id="mk-wh-twitter" class="input-premium" placeholder="Laisser vide pour Mode Direct" style="font-size:12px;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Telegram -->
                <div class="net-card">
                    <div class="net-header">
                        <div class="net-title">‚úàÔ∏è Telegram</div>
                        <label class="switch"><input type="checkbox" id="mk-ch-telegram"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select id="mk-fmt-telegram" class="input-premium" style="padding:8px;">
                            <option value="text_image">Texte + Image</option>
                            <option value="text">Texte seul</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="padding-top:12px;">
                            <div class="form-group">
                                <label>URL Profil</label>
                                <input id="mk-pf-telegram" class="input-premium" placeholder="URL Canal" style="font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label>Webhook (Optionnel)</label>
                                <input id="mk-wh-telegram" class="input-premium" placeholder="Laisser vide pour Mode Direct" style="font-size:12px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Discord -->
                <div class="net-card">
                    <div class="net-header">
                        <div class="net-title">üëæ Discord</div>
                        <label class="switch"><input type="checkbox" id="mk-ch-discord"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>Format</label>
                        <select id="mk-fmt-discord" class="input-premium" style="padding:8px;">
                            <option value="text_image">Texte + Image</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="padding-top:12px;">
                            <div class="form-group">
                                <label>URL Profil</label>
                                <input id="mk-pf-discord" class="input-premium" placeholder="URL Serveur" style="font-size:12px;">
                            </div>
                            <div class="form-group">
                                <label>Webhook (Obligatoire)</label>
                                <input id="mk-wh-discord" class="input-premium" placeholder="Webhook URL" style="font-size:12px;">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- General Config -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">‚öôÔ∏è Configuration G√©n√©rale</div>
                <div style="display:flex; gap:10px;">
                    <button id="mk-share-native" class="btn">‚ÜóÔ∏è Partager</button>
                    <button id="btn-preview-video" class="btn">üé• Aper√ßu Vid√©o</button>
                    <button id="mk-modal-help" class="btn">‚ùì Aide</button>
                    <button id="btn-collect-cookies" class="btn">üïµÔ∏è Collecter Cookies</button>
                </div>
            </div>
            <div class="grid-3">
                <div class="form-group">
                    <label>Template du Message</label>
                    <input id="mk-template" class="input-premium" placeholder="SurfSense: conditions live sur {spot} ‚Ä¢ {desc} #surf" />
                </div>
                <div class="form-group">
                    <label>Intervalle (Minutes)</label>
                    <input id="mk-interval" type="number" min="1" class="input-premium" placeholder="60" />
                </div>
                <div class="form-group">
                    <label>Webhook Agr√©gateur (Logs/Debug)</label>
                    <input id="mk-webhook" class="input-premium" placeholder="https://discord.com/api/webhooks/..." />
                </div>
                <!-- Hidden legacy fields -->
                <select id="mk-type" style="display:none;"><option value="story">Story</option></select>
            </div>
            <div class="form-group">
                <label>Poster en vid√©o (Reels/TikTok) par d√©faut</label>
                <label class="switch"><input type="checkbox" id="mk-autovideo"><span class="slider"></span></label>
            </div>
            <div style="margin-top:20px; font-size:12px; color:#64748b;">
                Email Support: <span id="mk-email-text" style="color:#94a3b8;">swellsync@outlook.fr</span>
                <a id="mk-email-link" href="#" style="color:var(--accent); text-decoration:none; margin-left:8px;">Envoyer</a>
                <span id="mk-email-copy" style="cursor:pointer; color:var(--accent); margin-left:8px;">Copier</span>
            </div>
        </div>

        <!-- Planification Avanc√©e -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">‚è±Ô∏è Planification Avanc√©e</div>
            </div>
            <div class="grid-3">
                <div class="form-group">
                    <label>Autopost (Robot)</label>
                    <label class="switch"><input type="checkbox" id="mk-autopost"><span class="slider"></span></label>
                </div>
                <div class="form-group">
                    <label>Hashtags (s√©par√©s par espaces)</label>
                    <textarea id="mk-tags" class="input-premium" style="height:78px;" placeholder="#surf #vagues #ocean #report"></textarea>
                </div>
                <div class="form-group">
                    <label>Intervalles par r√©seau (minutes)</label>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <input id="mk-iv-instagram" class="input-premium" type="number" min="1" placeholder="Instagram"/>
                        <input id="mk-iv-threads" class="input-premium" type="number" min="1" placeholder="Threads"/>
                        <input id="mk-iv-twitter" class="input-premium" type="number" min="1" placeholder="X"/>
                        <input id="mk-iv-facebook" class="input-premium" type="number" min="1" placeholder="Facebook"/>
                        <input id="mk-iv-youtube" class="input-premium" type="number" min="1" placeholder="YouTube"/>
                        <input id="mk-iv-telegram" class="input-premium" type="number" min="1" placeholder="Telegram"/>
                        <input id="mk-iv-discord" class="input-premium" type="number" min="1" placeholder="Discord"/>
                        <input id="mk-iv-tiktok" class="input-premium" type="number" min="1" placeholder="TikTok"/>
                    </div>
                </div>
            </div>
            <div style="padding:8px 0 0;">
                <button id="mk-save" class="btn btn-primary">üíæ Sauvegarder Config</button>
                <button id="mk-start" class="btn">‚ñ∂Ô∏è D√©marrer</button>
                <button id="mk-stop" class="btn">‚è∏Ô∏è Stop</button>
            </div>
        </div>

      </main>
    </div>

    <!-- Scripts (Inline Logic Preserved) -->
    <script>
      (function(){
        // Load Sidebar
        fetch("/admin/nav.html").then(r=>r.text()).then(html=>{
             const el=document.getElementById("admin-nav");
             if(el) {
                 el.innerHTML=html;
                 // Active link logic
                 const path = window.location.pathname;
                 const links = el.querySelectorAll('.nav-item');
                 links.forEach(l => {
                    const href = l.getAttribute('href');
                    if(href === path || (path.endsWith('/admin/') && href === '/admin/')) {
                        l.classList.add('active');
                    }
                 });
             }
        }).catch(()=>{});

        // Main Logic
        const params = new URLSearchParams(window.location.search);
        const tParam = params.get("token");
        if (tParam) { try { localStorage.setItem("surfAdminToken", tParam); history.replaceState({}, "", window.location.pathname); } catch {} }
        const tok = localStorage.getItem("surfAdminToken") || "";
        const headers = tok ? { "x-admin-token": tok } : {};
        const q = (id) => document.getElementById(id);
        const postSingle = async (network) => {
          try {
            const r = await fetch("/api/admin/social/post", { method: "POST", headers: { ...headers, "Content-Type": "application/json" }, body: JSON.stringify({ network }) });
            const j = await r.json();
            if (r.ok && j.success) alert(`‚úÖ ${network} publi√© (${j.mode})`);
            else alert(`‚ÑπÔ∏è ${network} en reprise automatique`);
          } catch (e) { alert(`‚ÑπÔ∏è ${network} en reprise automatique`); }
        };
        const postAll = async (nets) => {
          try {
            const r = await fetch("/api/admin/social/post-all", { method: "POST", headers: { ...headers, "Content-Type": "application/json" }, body: JSON.stringify({ networks: nets }) });
            const j = await r.json();
            if (r.ok && j.success) {
              const okList = j.results.filter(x=>x.ok).map(x=>x.network).join(", ");
              const koList = j.results.filter(x=>!x.ok).map(x=>x.network).join(", ");
              alert(`‚úÖ Publi r√©ussie: ${okList}\n‚ÑπÔ∏è Reprise automatique: ${koList || "aucune"}`);
            } else {
              alert("‚ÑπÔ∏è Publication en reprise automatique");
            }
          } catch (e) {
            alert("‚ÑπÔ∏è Publication en reprise automatique");
          }
        };
        const openPostAllModal = () => {
          const preset = [
            { id:"instagram", label:"Instagram", checked: q("mk-ch-instagram")?.checked },
            { id:"threads", label:"Threads", checked: q("mk-ch-threads")?.checked },
            { id:"twitter", label:"X/Twitter", checked: q("mk-ch-twitter")?.checked },
            { id:"facebook", label:"Facebook", checked: q("mk-ch-facebook")?.checked },
            { id:"youtube", label:"YouTube", checked: q("mk-ch-youtube")?.checked },
            { id:"tiktok", label:"TikTok", checked: q("mk-ch-tiktok")?.checked },
            { id:"telegram", label:"Telegram", checked: q("mk-ch-telegram")?.checked },
            { id:"discord", label:"Discord", checked: q("mk-ch-discord")?.checked }
          ];
          const modal = document.createElement("div");
          modal.style.cssText = "position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; display:flex; align-items:center; justify-content:center;";
          const items = preset.map(p => `
            <label style="display:flex; align-items:center; gap:8px; padding:8px; border:1px solid #334155; border-radius:8px;">
              <input type="checkbox" id="sel-${p.id}" ${p.checked ? "checked" : ""}/>
              <span>${p.label}</span>
            </label>
          `).join("");
          modal.innerHTML = `
            <div style="background:#0f172a; color:#fff; padding:24px; border-radius:12px; width:520px; max-width:95%;">
              <div style="font-weight:700; margin-bottom:12px;">S√©lection des r√©seaux</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px;">${items}</div>
              <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button id="close-postall" class="btn">Annuler</button>
                <button id="do-postall" class="btn btn-primary">Publier</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          modal.querySelector("#close-postall").onclick = () => modal.remove();
          modal.querySelector("#do-postall").onclick = async () => {
            const nets = preset.filter(p => modal.querySelector("#sel-"+p.id).checked).map(p => p.id);
            modal.remove();
            await postAll(nets.length ? nets : preset.map(p=>p.id));
          };
        };
        const openSecretsModal = () => {
          const modal = document.createElement("div");
          modal.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; justify-content:center; align-items:center;";
          modal.innerHTML = `
            <div style="background:#0f172a; padding:24px; border-radius:12px; width:90%; max-width:720px; border:1px solid #334155; color:#e5e7eb; font-family:sans-serif;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div style="font-weight:700;">Configurer les cl√©s</div>
                <button id="mk-close-secrets" class="btn">Fermer</button>
              </div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; max-height:60vh; overflow:auto;">
                <input id="INSTAGRAM_USERNAME" placeholder="INSTAGRAM_USERNAME" class="input-premium"/>
                <input id="INSTAGRAM_PASSWORD" placeholder="INSTAGRAM_PASSWORD" type="password" class="input-premium"/>
                <input id="INSTAGRAM_TOTP_SECRET" placeholder="INSTAGRAM_TOTP_SECRET" class="input-premium"/>
                <input id="THREADS_USERNAME" placeholder="THREADS_USERNAME" class="input-premium"/>
                <input id="THREADS_PASSWORD" placeholder="THREADS_PASSWORD" type="password" class="input-premium"/>
                <input id="TWITTER_API_KEY" placeholder="TWITTER_API_KEY" class="input-premium"/>
                <input id="TWITTER_API_SECRET" placeholder="TWITTER_API_SECRET" class="input-premium"/>
                <input id="TWITTER_ACCESS_TOKEN" placeholder="TWITTER_ACCESS_TOKEN" class="input-premium"/>
                <input id="TWITTER_ACCESS_SECRET" placeholder="TWITTER_ACCESS_SECRET" class="input-premium"/>
                <input id="TWITTER_USERNAME" placeholder="TWITTER_USERNAME" class="input-premium"/>
                <input id="TWITTER_PASSWORD" placeholder="TWITTER_PASSWORD" type="password" class="input-premium"/>
                <input id="TELEGRAM_BOT_TOKEN" placeholder="TELEGRAM_BOT_TOKEN" class="input-premium"/>
                <input id="TELEGRAM_CHAT_ID" placeholder="TELEGRAM_CHAT_ID" class="input-premium"/>
                <input id="FACEBOOK_PAGE_ACCESS_TOKEN" placeholder="FACEBOOK_PAGE_ACCESS_TOKEN" class="input-premium"/>
                <input id="FACEBOOK_PAGE_ID" placeholder="FACEBOOK_PAGE_ID" class="input-premium"/>
                <input id="FACEBOOK_USERNAME" placeholder="FACEBOOK_USERNAME" class="input-premium"/>
                <input id="FACEBOOK_PASSWORD" placeholder="FACEBOOK_PASSWORD" type="password" class="input-premium"/>
                <input id="YOUTUBE_CLIENT_ID" placeholder="YOUTUBE_CLIENT_ID" class="input-premium"/>
                <input id="YOUTUBE_CLIENT_SECRET" placeholder="YOUTUBE_CLIENT_SECRET" class="input-premium"/>
                <input id="YOUTUBE_REFRESH_TOKEN" placeholder="YOUTUBE_REFRESH_TOKEN" class="input-premium"/>
                <input id="GOOGLE_LOGIN_EMAIL" placeholder="GOOGLE_LOGIN_EMAIL" class="input-premium"/>
                <input id="GOOGLE_LOGIN_PASSWORD" placeholder="GOOGLE_LOGIN_PASSWORD" type="password" class="input-premium"/>
                <input id="GOOGLE_TOTP_SECRET" placeholder="GOOGLE_TOTP_SECRET" class="input-premium"/>
                <input id="SMTP_FROM" placeholder="SMTP_FROM" class="input-premium"/>
                <input id="SMTP_HOST" placeholder="SMTP_HOST" class="input-premium"/>
                <input id="SMTP_PORT" placeholder="SMTP_PORT" class="input-premium"/>
                <input id="SMTP_USER" placeholder="SMTP_USER" class="input-premium"/>
                <input id="SMTP_PASS" placeholder="SMTP_PASS" type="password" class="input-premium"/>
                <input id="BASE_URL" placeholder="BASE_URL" class="input-premium"/>
                <input id="ADMIN_EMAIL" placeholder="ADMIN_EMAIL" class="input-premium"/>
                <input id="ADMIN_TOKEN" placeholder="ADMIN_TOKEN" class="input-premium"/>
                <select id="PUPPETEER_DISABLE" class="input-premium"><option value="">PUPPETEER_DISABLE</option><option value="1">1</option><option value="0">0</option></select>
                <select id="NO_BROWSER" class="input-premium"><option value="">NO_BROWSER</option><option value="1">1</option><option value="0">0</option></select>
              </div>
              <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:12px;">
                <button id="mk-save-secrets" class="btn btn-primary">Enregistrer .env</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          modal.querySelector("#mk-close-secrets").onclick = () => modal.remove();
          modal.querySelector("#mk-save-secrets").onclick = async () => {
            const ids = ["INSTAGRAM_USERNAME","INSTAGRAM_PASSWORD","INSTAGRAM_TOTP_SECRET","THREADS_USERNAME","THREADS_PASSWORD","TWITTER_API_KEY","TWITTER_API_SECRET","TWITTER_ACCESS_TOKEN","TWITTER_ACCESS_SECRET","TWITTER_USERNAME","TWITTER_PASSWORD","TELEGRAM_BOT_TOKEN","TELEGRAM_CHAT_ID","FACEBOOK_PAGE_ACCESS_TOKEN","FACEBOOK_PAGE_ID","FACEBOOK_USERNAME","FACEBOOK_PASSWORD","YOUTUBE_CLIENT_ID","YOUTUBE_CLIENT_SECRET","YOUTUBE_REFRESH_TOKEN","GOOGLE_LOGIN_EMAIL","GOOGLE_LOGIN_PASSWORD","GOOGLE_TOTP_SECRET","SMTP_FROM","SMTP_HOST","SMTP_PORT","SMTP_USER","SMTP_PASS","BASE_URL","ADMIN_EMAIL","ADMIN_TOKEN","PUPPETEER_DISABLE","NO_BROWSER"];
            const env = {};
            ids.forEach(id => {
              const el = modal.querySelector("#"+id);
              if (el && el.value) env[id] = el.value;
            });
            try {
              const r = await fetch("/api/admin/secrets/save", { method: "POST", headers: { ...headers, "Content-Type": "application/json" }, body: JSON.stringify({ env }) });
              const j = await r.json();
              if (r.ok && j.success) {
                alert("‚úÖ Cl√©s enregistr√©es. Red√©marre le serveur pour prise en compte.");
                modal.remove();
              } else {
                alert("Erreur: " + (j.error || "inconnue"));
              }
            } catch (e) {
              alert("Erreur: " + e.message);
            }
          };
          modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        };
        
        // Native Share
        if (q("mk-share-native")) {
            q("mk-share-native").onclick = async () => {
                const tmpl = q("mk-template").value;
                const url = window.location.origin;
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'SurfSense Live',
                            text: tmpl.replace('{spot}', 'Spot').replace('{desc}', 'Conditions...'),
                            url: url
                        });
                    } catch (err) { console.log('Share canceled', err); }
                } else {
                    alert("Le partage n'est pas support√© sur ce navigateur.");
                }
            };
        }

        // Cookie Import
        if (q("btn-import-cookies")) {
            q("btn-import-cookies").onclick = async () => {
                const input = document.createElement("input");
                input.type = "file";
                input.accept = ".json";
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const text = await file.text();
                    try {
                        JSON.parse(text); 
                        const r = await fetch("/api/admin/marketing/cookies", {
                            method: "POST",
                            headers: { "Content-Type": "application/json", ...headers },
                            body: text
                        });
                        if (r.ok) alert("‚úÖ Cookies Stealth import√©s avec succ√®s !");
                        else alert("Erreur import cookies");
                    } catch {
                        alert("Fichier JSON invalide");
                    }
                };
                input.click();
              };
          }
        
        if (q("btn-collect-cookies")) {
            q("btn-collect-cookies").onclick = async () => {
                try {
                    const r = await fetch("/api/admin/marketing/cookies/collect", {
                        method: "POST",
                        headers: { ...headers, "Content-Type": "application/json" },
                        body: JSON.stringify({ networks: ["instagram","twitter","tiktok","facebook","youtube"], timeoutMs: 20000 })
                    });
                    const j = await r.json();
                    if (r.ok && j.success) {
                        alert("‚úÖ Cookies collect√©s\n\n" + (j.details || []).join("\n"));
                        loadMarketing();
                    } else {
                        alert("Erreur collecte: " + (j.error || "inconnue"));
                    }
                } catch (e) { alert("Erreur collecte: " + e.message); }
            };
        }
        
        // Profile Update
        if (q("btn-update-profile")) {
            q("btn-update-profile").onclick = async () => {
                const photoInput = q("mk-profile-photo");
                const bio = q("mk-profile-bio").value.trim();
                
                if (!photoInput.files[0] && !bio) {
                    alert("Veuillez fournir une photo ou une bio.");
                    return;
                }

                const btn = q("btn-update-profile");
                const originalText = btn.textContent;
                btn.textContent = "Mise √† jour en cours... (Peut prendre 2-3 min)";
                btn.disabled = true;

                try {
                    const formData = new FormData();
                    if (photoInput.files[0]) formData.append("photo", photoInput.files[0]);
                    if (bio) formData.append("bio", bio);

                    const r = await fetch("/api/admin/marketing/update-profile", {
                        method: "POST",
                        headers: { "x-admin-token": tok }, 
                        body: formData
                    });
                    
                    const res = await r.json();
                    if (r.ok && res.success) {
                        alert("‚úÖ Profils mis √† jour avec succ√®s !\n\nD√©tails:\n" + res.details.join("\n"));
                    } else {
                        alert("‚ö†Ô∏è Mise √† jour partielle ou √©chou√©e:\n" + (res.error || res.details?.join("\n")));
                    }
                } catch (e) {
                    alert("Erreur: " + e.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            };
        }

        async function loadMarketing() {
          try {
            const r = await fetch("/api/admin/marketing/status", { headers });
            const s = await r.json();
            const statusEl = q("mk-status");
            const lastRun = s.lastRunAt ? new Date(s.lastRunAt).toLocaleTimeString("fr-FR") : "-";
            const reason = s.reason || (s.running ? "running" : "paused");
            statusEl.textContent = "Status: "+(s.running ? "RUNNING" : "STOPPED")+" ‚Ä¢ "+(s.intervalMinutes||"-")+" min ‚Ä¢ "+reason+" ‚Ä¢ last: "+lastRun;
            statusEl.style.color = s.running ? "#4ade80" : "#f87171";
            if (!s.browserAvailable) {
              const el1 = q("btn-collect-cookies"); if (el1) el1.style.display = "none";
              const el2 = q("btn-import-cookies"); if (el2) el2.style.display = "none";
            }
            
            if (s.cookieStatus) {
                const updateBadge = (id, active) => {
                    const el = q(id);
                    if (!el) return;
                    if (active) {
                        el.textContent = "Stealth OK";
                        el.classList.add("active");
                        el.classList.remove("missing");
                    } else {
                        el.textContent = "No Cookies";
                        el.classList.add("missing");
                        el.classList.remove("active");
                    }
                };
                updateBadge("st-instagram", s.cookieStatus.instagram);
                updateBadge("st-facebook", s.cookieStatus.facebook);
                updateBadge("st-tiktok", s.cookieStatus.tiktok);
                updateBadge("st-youtube", s.cookieStatus.youtube);
                updateBadge("st-twitter", s.cookieStatus.twitter);
            }
          } catch {}
          try {
            const rr = await fetch("/api/admin/marketing/config", { headers });
            const c = await rr.json();
            q("mk-webhook").value = c.webhookUrl || "";
            q("mk-interval").value = c.intervalMinutes || "";
            q("mk-template").value = c.template || "";
            q("mk-type").value = c.contentType || "story";
            if (q("mk-autopost")) q("mk-autopost").checked = !!c.autopostEnabled;
            if (q("mk-autovideo")) q("mk-autovideo").checked = !!c.autopostVideoReelsTikTokDefault;
            if (q("mk-tags")) q("mk-tags").value = Array.isArray(c.hashtags) ? c.hashtags.join(" ") : "";
            const ivs = c.networkIntervals || {};
            const setIv = (id, v) => { const el=q(id); if(el) el.value = v || ""; };
            setIv("mk-iv-instagram", ivs.instagram);
            setIv("mk-iv-threads", ivs.threads);
            setIv("mk-iv-twitter", ivs.twitter);
            setIv("mk-iv-facebook", ivs.facebook);
            setIv("mk-iv-youtube", ivs.youtube);
            setIv("mk-iv-telegram", ivs.telegram);
            setIv("mk-iv-discord", ivs.discord);
            setIv("mk-iv-tiktok", ivs.tiktok);
            const chs = new Set(c.channels || []);
            q("mk-ch-instagram").checked = chs.has("instagram");
            q("mk-ch-facebook").checked = chs.has("facebook");
            q("mk-ch-tiktok").checked = chs.has("tiktok");
            q("mk-ch-threads").checked = chs.has("threads");
            q("mk-ch-youtube").checked = chs.has("youtube");
            q("mk-ch-twitter").checked = chs.has("twitter");
            q("mk-ch-telegram").checked = chs.has("telegram");
            q("mk-ch-discord").checked = chs.has("discord");
            const cx = c.connectors || {};
            q("mk-wh-instagram").value = cx.instagram?.webhook || "";
            q("mk-wh-facebook").value = cx.facebook?.webhook || "";
            q("mk-wh-tiktok").value = cx.tiktok?.webhook || "";
            q("mk-wh-threads").value = cx.threads?.webhook || "";
            q("mk-wh-youtube").value = cx.youtube?.webhook || "";
            q("mk-wh-twitter").value = cx.twitter?.webhook || "";
            q("mk-wh-telegram").value = cx.telegram?.webhook || "";
            q("mk-wh-discord").value = cx.discord?.webhook || "";
            
            if (cx.instagram?.format) q("mk-fmt-instagram").value = cx.instagram.format;
            if (cx.facebook?.format) q("mk-fmt-facebook").value = cx.facebook.format;
            if (cx.tiktok?.format) q("mk-fmt-tiktok").value = cx.tiktok.format;
            if (cx.threads?.format) q("mk-fmt-threads").value = cx.threads.format;
            if (cx.youtube?.format) q("mk-fmt-youtube").value = cx.youtube.format;
            if (cx.twitter?.format) q("mk-fmt-twitter").value = cx.twitter.format;
            if (cx.telegram?.format) q("mk-fmt-telegram").value = cx.telegram.format;
            if (cx.discord?.format) q("mk-fmt-discord").value = cx.discord.format;

            q("mk-pf-instagram").value = cx.instagram?.profileUrl || "";
            q("mk-pf-facebook").value = cx.facebook?.profileUrl || "";
            q("mk-pf-tiktok").value = cx.tiktok?.profileUrl || "";
            q("mk-pf-threads").value = cx.threads?.profileUrl || "";
            q("mk-pf-youtube").value = cx.youtube?.profileUrl || "";
            q("mk-pf-twitter").value = cx.twitter?.profileUrl || "";
            q("mk-pf-telegram").value = cx.telegram?.profileUrl || "";
            q("mk-pf-discord").value = cx.discord?.profileUrl || "";
            const em = c.email || "swellsync@outlook.fr";
            q("mk-email-text").textContent = em;
            q("mk-email-link").href = "mailto:"+em;
          } catch {}
        }
        q("mk-email-copy").onclick = async () => {
          try {
            await navigator.clipboard.writeText(q("mk-email-text").textContent.trim());
            alert("Adresse copi√©e");
          } catch {}
        };
        q("mk-modal-help").onclick = () => {
            const modal = document.createElement("div");
            modal.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; justify-content:center; align-items:center;";
            modal.innerHTML = `
                <div style="background:#1e293b; padding:24px; border-radius:12px; max-width:500px; color:#f8fafc; font-family:sans-serif; position:relative;">
                    <button id="mk-close-help" style="position:absolute; top:12px; right:12px; background:none; border:none; color:#94a3b8; font-size:18px; cursor:pointer;">&times;</button>
                    <h3 style="margin-top:0; color:#3b82f6;">Guide du Mode Direct</h3>
                    <p style="font-size:13px; line-height:1.6; color:#cbd5e1;">
                        Le <strong>Mode Direct</strong> permet au serveur de poster directement sur vos r√©seaux sans passer par Make.com.
                        Pour l'activer, laissez le champ "Webhook" vide pour les r√©seaux compatibles.
                    </p>
                    <ul style="color:#e5e7eb; line-height:1.6; font-size:13px; padding-left:20px;">
                        <li>üì∏ <strong>Instagram</strong> : Support√© (Images/Stories)</li>
                        <li>üßµ <strong>Threads</strong> : Support√©</li>
                        <li>‚úñÔ∏è <strong>X / Twitter</strong> : Support√©</li>
                        <li>‚úàÔ∏è <strong>Telegram</strong> : Support√©</li>
                        <li>üëæ <strong>Discord</strong> : Support√© (Mettre URL Webhook dans admin)</li>
                        <li>üìò <strong>Facebook</strong> : Support√© (N√©cessite Page Token dans .env)</li>
                        <li>üì∫ <strong>YouTube</strong> : Support√© (L'image est convertie en vid√©o de 5s automatiquement). N√©cessite API Keys.</li>
                    </ul>
                    <p style="font-size:12px; color:#facc15; margin-top:12px; background:#422006; padding:8px; border-radius:4px;">
                        ‚ö†Ô∏è <strong>TikTok</strong> : API publique ferm√©e aux posts automatiques simples. 
                        Le serveur ne peut pas poster directement sur TikTok pour le moment sans risque de blocage.
                        Utilisez le Webhook pour TikTok.
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector("#mk-close-help").onclick = () => modal.remove();
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        };
        q("btn-preview-video").onclick = async () => {
             const btn = q("btn-preview-video");
             const originalText = btn.textContent;
             btn.textContent = "G√©n√©ration en cours... (15-30s)";
             btn.disabled = true;

             try {
                 const res = await fetch("/api/admin/preview-video?spot=Anglet"); // Default spot for preview
                 if (!res.ok) throw new Error("Erreur g√©n√©ration");
                 
                 const blob = await res.blob();
                 const url = URL.createObjectURL(blob);
                 
                 const modal = document.createElement("div");
                 modal.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; flex-direction:column; justify-content:center; align-items:center;";
                 modal.innerHTML = `
                     <div style="position:relative; width:300px; height:533px; background:#000;">
                        <video src="${url}" controls autoplay style="width:100%; height:100%; object-fit:cover;"></video>
                        <button id="close-vid" style="position:absolute; top:-40px; right:0; color:white; background:none; border:none; font-size:24px;">&times;</button>
                     </div>
                     <a href="${url}" download="montage_preview.mp4" style="margin-top:20px; color:#3b82f6; text-decoration:none;">‚¨áÔ∏è T√©l√©charger la vid√©o</a>
                 `;
                 document.body.appendChild(modal);
                 modal.querySelector("#close-vid").onclick = () => modal.remove();
                 
             } catch (e) {
                 alert("Erreur: " + e.message);
             } finally {
                 btn.textContent = originalText;
                 btn.disabled = false;
             }
        };

        q("mk-save").onclick = async () => {
          const channels = [];
          if (q("mk-ch-instagram").checked) channels.push("instagram");
          if (q("mk-ch-facebook").checked) channels.push("facebook");
          if (q("mk-ch-tiktok").checked) channels.push("tiktok");
          if (q("mk-ch-threads").checked) channels.push("threads");
          if (q("mk-ch-youtube").checked) channels.push("youtube");
          if (q("mk-ch-twitter").checked) channels.push("twitter");
          if (q("mk-ch-telegram").checked) channels.push("telegram");
          if (q("mk-ch-discord").checked) channels.push("discord");
          const networkIntervals = {
            instagram: parseInt(q("mk-iv-instagram").value,10) || undefined,
            threads: parseInt(q("mk-iv-threads").value,10) || undefined,
            twitter: parseInt(q("mk-iv-twitter").value,10) || undefined,
            facebook: parseInt(q("mk-iv-facebook").value,10) || undefined,
            youtube: parseInt(q("mk-iv-youtube").value,10) || undefined,
            telegram: parseInt(q("mk-iv-telegram").value,10) || undefined,
            discord: parseInt(q("mk-iv-discord").value,10) || undefined,
            tiktok: parseInt(q("mk-iv-tiktok").value,10) || undefined
          };
          Object.keys(networkIntervals).forEach(k => { if (!networkIntervals[k]) delete networkIntervals[k]; });
          const hashtags = (q("mk-tags").value || "").split(/\s+/).map(x=>x.trim()).filter(Boolean);
          const connectors = {
            instagram: { enabled: q("mk-ch-instagram").checked, webhook: q("mk-wh-instagram").value.trim(), profileUrl: q("mk-pf-instagram").value.trim(), format: q("mk-fmt-instagram").value },
            facebook: { enabled: q("mk-ch-facebook").checked, webhook: q("mk-wh-facebook").value.trim(), profileUrl: q("mk-pf-facebook").value.trim(), format: q("mk-fmt-facebook").value },
            tiktok: { enabled: q("mk-ch-tiktok").checked, webhook: q("mk-wh-tiktok").value.trim(), profileUrl: q("mk-pf-tiktok").value.trim(), format: q("mk-fmt-tiktok").value },
            threads: { enabled: q("mk-ch-threads").checked, webhook: q("mk-wh-threads").value.trim(), profileUrl: q("mk-pf-threads").value.trim(), format: q("mk-fmt-threads").value },
            youtube: { enabled: q("mk-ch-youtube").checked, webhook: q("mk-wh-youtube").value.trim(), profileUrl: q("mk-pf-youtube").value.trim(), format: q("mk-fmt-youtube").value },
            twitter: { enabled: q("mk-ch-twitter").checked, webhook: q("mk-wh-twitter").value.trim(), profileUrl: q("mk-pf-twitter").value.trim(), format: q("mk-fmt-twitter").value },
            telegram: { enabled: q("mk-ch-telegram").checked, webhook: q("mk-wh-telegram").value.trim(), profileUrl: q("mk-pf-telegram").value.trim(), format: q("mk-fmt-telegram").value },
            discord: { enabled: q("mk-ch-discord").checked, webhook: q("mk-wh-discord").value.trim(), profileUrl: q("mk-pf-discord").value.trim(), format: q("mk-fmt-discord").value }
          };
          try {
            const rr = await fetch("/api/admin/marketing/config", {
              method: "POST",
              headers: { ...headers, "Content-Type":"application/json" },
              body: JSON.stringify({
                channels,
                webhookUrl: q("mk-webhook").value.trim(),
                template: q("mk-template").value,
                contentType: q("mk-type").value,
                autopostEnabled: !!q("mk-autopost").checked,
                autopostVideoReelsTikTokDefault: !!q("mk-autovideo").checked,
                hashtags,
                networkIntervals,
                connectors
              })
            });
            const dj = await rr.json();
            if (!rr.ok || !dj.success) { alert("Erreur configuration"); return; }
            loadMarketing();
          } catch { alert("Erreur configuration"); }
        };
        q("mk-fire").onclick = async () => {
          try {
            const rr = await fetch("/api/admin/marketing/fire", { method: "POST", headers });
            const dj = await rr.json();
            if (!rr.ok || !dj.success) { alert("Erreur publication"); return; }
            alert("Publication envoy√©e");
          } catch { alert("Erreur publication"); }
        };
        if (q("mk-post-ig")) q("mk-post-ig").onclick = () => postSingle("instagram");
        if (q("mk-post-x")) q("mk-post-x").onclick = () => postSingle("twitter");
        if (q("mk-post-fb")) q("mk-post-fb").onclick = () => postSingle("facebook");
        if (q("mk-post-yt")) q("mk-post-yt").onclick = () => postSingle("youtube");
        if (q("mk-post-th")) q("mk-post-th").onclick = () => postSingle("threads");
        if (q("mk-post-all")) q("mk-post-all").onclick = () => openPostAllModal();
        if (q("mk-secrets")) q("mk-secrets").onclick = () => openSecretsModal();
        if (q("mk-repair-login")) q("mk-repair-login").onclick = async () => {
          try {
            const nets = ["instagram","twitter","facebook","youtube","tiktok"];
            const r = await fetch("/api/admin/marketing/human-login", { method: "POST", headers: { ...headers, "Content-Type": "application/json" }, body: JSON.stringify({ networks: nets }) });
            const j = await r.json();
            if (r.ok) {
              const okList = j.results.filter(x=>x.ok).map(x=>x.network).join(", ");
              const koList = j.results.filter(x=>!x.ok).map(x=>x.network).join(", ");
              alert(`‚úîÔ∏è Connexions r√©par√©es: ${okList || "aucune"}\n‚ùå √âchecs: ${koList || "aucun"}`);
              loadMarketing();
            } else {
              alert("Erreur r√©paration: " + (j.error || "inconnue"));
            }
          } catch (e) {
            alert("Erreur r√©paration: " + e.message);
          }
        };
        if (q("mk-anti-bot")) q("mk-anti-bot").onclick = async () => {
          try {
            const r = await fetch("/api/admin/marketing/advice", { method: "POST", headers });
            const j = await r.json();
            if (!r.ok || !j.success) { alert("Conseils indisponibles"); return; }
            const lines = Object.entries(j.advice).map(([net, adv]) => {
              const hrs = (adv.bestHours || []).map(h => `${h}h`).join(", ");
              return `${net}: hashtags‚â§${adv.hashtagsMax||adv.tagsMax||6}, caption ${adv.captionMin||"-"}‚Äì${adv.captionMax||"-"}, heures ${hrs}, jitter ${adv.jitterMin}-${adv.jitterMax}min`;
            });
            alert(lines.join("\n"));
          } catch { alert("Conseils indisponibles"); }
        };
        if (q("mk-preview-pro")) q("mk-preview-pro").onclick = async (ev) => {
          const spot = prompt("Spot pour le montage:", "Biarritz") || "Spot";
          const ref = prompt("URL de r√©f√©rence (optionnel):", "") || "";
          let style = prompt("Style (Dark/Neon/Sunset/Ocean/Forest/Retro):", "Neon") || "Neon";
          let fx = prompt("FX (glitch/shake/fade/retro/none):", "fade") || "fade";
          let hook = prompt("Hook (none/medium/strong):", "strong") || "strong";
          let loop = confirm("Boucle invisible (seamless) ?") ? "1" : "0";
          let wm = confirm("Ajouter watermark swellsync.fr ?") ? "1" : "0";
          let cg = prompt("Color Grading (none/tealorange/cinematic/retro):", "tealorange") || "tealorange";
          let variability = prompt("Variabilit√© (0-10):", "5") || "5";
          let subs = confirm("Activer sous-titres dynamiques ?");
          let subtext = subs ? (prompt("Texte des sous-titres:", `${spot} ‚Ä¢ Conditions LIVE`) || `${spot} ‚Ä¢ Conditions LIVE`) : "";
          let substyle = subs ? (prompt("Style sous-titres (light/neon/default):", "light") || "light") : "";
          let sfx = prompt("SFX audio (none/whoosh/hit):", "whoosh") || "whoosh";
          let sfxi = prompt("Intensit√© SFX (0-100):", "70") || "70";
          let subsize = prompt("Taille sous-titre (16-64):", "34") || "34";
          try {
            if (ref && ref.startsWith("http")) {
              const rs = await fetch("/api/admin/marketing/style-suggest", { method: "POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ referenceUrl: ref }) });
              const js = await rs.json();
              if (rs.ok && js.success) { style = js.styleName || style; fx = js.fxPreset || fx; }
            }
            const btn = ev.currentTarget;
            const originalText = btn.textContent;
            btn.textContent = "‚è≥ G√©n√©ration...";
            btn.disabled = true;
            const params = new URLSearchParams({ spot, style, fx, hook, loop, wm, cg, var: variability, subtext, substyle, sfx, sfxi, subsize });
            const res = await fetch(`/api/admin/marketing/montage/preview?${params.toString()}`, { headers });
            if (!res.ok) throw new Error("Erreur g√©n√©ration");
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const modal = document.createElement("div");
            modal.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; flex-direction:column; justify-content:center; align-items:center;";
            modal.innerHTML = `
              <div style="position:relative; width:300px; height:533px; background:#000;">
                 <video src="${url}" controls autoplay style="width:100%; height:100%; object-fit:cover;"></video>
                 <button id="close-vid" style="position:absolute; top:-40px; right:0; color:white; background:none; border:none; font-size:24px;">&times;</button>
              </div>
              <a href="${url}" download="montage_preview.mp4" style="margin-top:20px; color:#3b82f6; text-decoration:none;">‚¨áÔ∏è T√©l√©charger la vid√©o</a>
            `;
            document.body.appendChild(modal);
            modal.querySelector("#close-vid").onclick = () => modal.remove();
          } catch (e) {
            alert("Erreur: " + e.message);
          } finally {
            const btn = ev.currentTarget;
            btn.textContent = "üé¨ Pr√©visualiser Montage Pro";
            btn.disabled = false;
          }
        };
        if (q("mk-trends")) q("mk-trends").onclick = async () => {
          try {
            const r = await fetch("/api/trends", { headers });
            const j = await r.json();
            if (!r.ok) { alert("Tendances indisponibles"); return; }
            const list = (j || []).slice(0, 12).map(t => `‚Ä¢ ${t.title} (${t.source})`).join("<br/>");
            const modal = document.createElement("div");
            modal.style.cssText = "position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:10000; display:flex; align-items:center; justify-content:center;";
            modal.innerHTML = `
              <div style="background:#0b1020; color:#fff; padding:24px; border-radius:12px; width:600px; max-width:90%;">
                <h3 style="margin-top:0;">Tendances du moment</h3>
                <div style="line-height:1.6">${list || "Aucune tendance d√©tect√©e"}</div>
                <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
                  <button id="close-trends" class="btn">Fermer</button>
                </div>
              </div>`;
            document.body.appendChild(modal);
            modal.querySelector("#close-trends").onclick = () => modal.remove();
          } catch { alert("Tendances indisponibles"); }
        };
        if (q("mk-publish-trend")) q("mk-publish-trend").onclick = async (ev) => {
          const btn = ev.currentTarget;
          const original = btn.textContent;
          btn.textContent = "‚è≥ Publication...";
          btn.disabled = true;
          try {
            const r = await fetch("/api/admin/marketing/trends/post", { method: "POST", headers });
            const j = await r.json();
            if (r.ok && j.success) alert("‚úÖ Trend publi√©: " + j.topic);
            else alert("‚ùå √âchec: " + (j.error || "inconnu"));
          } catch (e) {
            alert("‚ùå √âchec: " + e.message);
          } finally {
            btn.textContent = original;
            btn.disabled = false;
          }
        };
        if (q("mk-videos")) q("mk-videos").onclick = async () => {
          try {
            const r = await fetch("/api/admin/marketing/videos", { headers });
            const j = await r.json();
            if (!r.ok || !j.success) { alert("Erreur liste vid√©os"); return; }
            const items = (j.videos || []).slice(0, 50);
            const modal = document.createElement("div");
            modal.style.cssText = "position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:10000; display:flex; align-items:center; justify-content:center;";
            const rows = items.map(v => `
              <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #1e293b;">
                <div>
                  <div style="font-weight:600;">${v.name}</div>
                  <div style="opacity:0.7; font-size:12px;">${(v.size/1024/1024).toFixed(2)} MB ‚Ä¢ ${new Date(v.mtime).toLocaleString()}</div>
                </div>
                <div style="display:flex; gap:12px;">
                  <a href="${v.url}" target="_blank" class="btn">Ouvrir</a>
                  <a href="${v.url}" download class="btn btn-primary">T√©l√©charger</a>
                </div>
              </div>
            `).join("");
            modal.innerHTML = `
              <div style="background:#0b1020; color:#fff; padding:24px; border-radius:12px; width:800px; max-width:95%; max-height:90vh; overflow:auto;">
                <h3 style="margin-top:0;">Vid√©os G√©n√©r√©es</h3>
                <div>${rows || "Aucune vid√©o g√©n√©r√©e pour l'instant."}</div>
                <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
                  <button id="close-videos" class="btn">Fermer</button>
                </div>
              </div>`;
            document.body.appendChild(modal);
            modal.querySelector("#close-videos").onclick = () => modal.remove();
          } catch { alert("Erreur liste vid√©os"); }
        };
        if (q("mk-publish-igtok")) q("mk-publish-igtok").onclick = async () => {
          try {
            const spot = prompt("Spot:", "Hossegor") || "Hossegor";
            let style = prompt("Style (Dark/Neon/Sunset/Ocean/Forest/Retro):", "Neon") || "Neon";
            let fx = prompt("FX (glitch/shake/fade/retro/none):", "fade") || "fade";
            let subs = confirm("Activer sous-titres dynamiques ?");
            let subtext = subs ? (prompt("Texte des sous-titres:", `${spot} ‚Ä¢ Conditions LIVE`) || `${spot} ‚Ä¢ Conditions LIVE`) : "";
            let substyle = subs ? (prompt("Style sous-titres (light/neon/default):", "light") || "light") : "";
            let subsize = subs ? (prompt("Taille sous-titre (16-64):", "34") || "34") : "";
            let sfx = prompt("SFX audio (none/whoosh/hit):", "whoosh") || "whoosh";
            let sfxi = prompt("Intensit√© SFX (0-100):", "70") || "70";
            const body = { spot, style, fx, subtext, substyle, subsize, sfx, sfxi, wm: "1", cg: "tealorange" };
            const r = await fetch("/api/admin/marketing/publish/igtok", { method: "POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify(body) });
            const j = await r.json();
            alert(j.success ? `Publi√©: ${j.posted.join(", ")}\nVid√©o: ${j.video}` : "√âchec: " + j.error);
          } catch { alert("Erreur publication Reels/TikTok"); }
        };
        q("mk-start").onclick = async () => {
          const iv = parseInt(q("mk-interval").value, 10) || 60;
          try {
            const rr = await fetch("/api/admin/marketing/start", {
              method: "POST",
              headers: { ...headers, "Content-Type":"application/json" },
              body: JSON.stringify({ intervalMinutes: iv })
            });
            const dj = await rr.json();
            if (!rr.ok || !dj.success) { alert("Erreur d√©marrage"); return; }
            loadMarketing();
          } catch { alert("Erreur d√©marrage"); }
        };
        q("mk-stop").onclick = async () => {
          try {
            const rr = await fetch("/api/admin/marketing/stop", { method: "POST", headers });
            const dj = await rr.json();
            if (!rr.ok || !dj.success) { alert("Erreur stop"); return; }
            loadMarketing();
          } catch { alert("Erreur stop"); }
        };
        loadMarketing();
      })();
    </script>
  </body>
</html>
