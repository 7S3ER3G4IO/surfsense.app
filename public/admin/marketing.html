<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin ‚Äî R√©seaux</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" href="../logo.svg" type="image/svg+xml" />
    <style>
      .admin-layout{display:flex;min-height:100vh}
      .admin-sidebar{width:260px;background:#0b0e16;border-right:1px solid #1f2937;padding:18px;position:sticky;top:0;height:100vh;backdrop-filter:blur(8px)}
      .admin-brand{display:flex;align-items:center;gap:10px;color:#e5e7eb;font-weight:800;margin-bottom:18px}
      .admin-nav a{display:block;padding:10px 12px;border-radius:12px;color:#c4b5fd;text-decoration:none;margin-bottom:6px;transition:background .2s, transform .1s}
      .admin-nav a:hover{background:#111827;transform:translateX(2px)}
      .admin-main{flex:1;padding:24px;background:radial-gradient(1200px 600px at -10% -10%, rgba(124,58,237,.12), transparent 60%),radial-gradient(1000px 500px at 110% 10%, rgba(34,197,94,.12), transparent 60%)}
      .admin-card{background:rgba(11,14,22,.7);backdrop-filter:blur(8px);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.35); margin-bottom: 24px;}
      .act-btn{background:#0b0e16;border:1px solid #1f2937;color:#e5e7eb;border-radius:10px;padding:8px 16px;transition:all .2s; cursor:pointer; font-weight:600;}
      .act-btn:hover{transform:translateY(-1px); border-color:#8b5cf6;}
      
      /* Premium UI */
      .premium-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; margin-top: 16px; }
      .net-card { background: rgba(17, 24, 39, 0.6); border: 1px solid rgba(124, 58, 237, 0.2); border-radius: 12px; padding: 16px; transition: all 0.2s; display:flex; flex-direction:column; }
      .net-card:hover { border-color: rgba(124, 58, 237, 0.5); background: rgba(17, 24, 39, 0.8); transform: translateY(-2px); }
      .net-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
      .net-title { font-weight: 700; color: #fff; display: flex; align-items: center; gap: 8px; font-size: 15px; }
      .net-body { display: flex; flex-direction: column; gap: 10px; flex:1; }
      
      .premium-input { background: #0b0e16; border: 1px solid #374151; color: #e5e7eb; padding: 10px 12px; border-radius: 8px; width: 100%; font-size: 13px; transition: border-color 0.2s; }
      .premium-input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
      .premium-select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 32px; cursor: pointer; }
      
      .toggle-switch { position: relative; width: 44px; height: 24px; }
      .toggle-switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #374151; transition: .4s; border-radius: 24px; }
      .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #8b5cf6; }
      input:checked + .slider:before { transform: translateX(20px); }
      
      .collapsible { overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0; }
      .collapsible.open { max-height: 200px; }
      .details-trigger { font-size: 11px; color: #94a3b8; cursor: pointer; text-decoration: underline; margin-top: auto; padding-top: 8px; }
      .details-trigger:hover { color: #c4b5fd; }
      
      .section-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
      .badge-pro { background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 8px; vertical-align: middle; }
    </style>
  </head>
  <body style="background:#080a12; color: #fff; font-family: 'Inter', system-ui, sans-serif;">
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div class="admin-brand">
          <img src="../logo.svg" alt="logo" width="24" height="24"/>
          <span>Admin</span>
        </div>
        <nav class="admin-nav" id="admin-nav"></nav>
      </aside>
      <main class="admin-main">
        <div class="section" style="max-width:1200px; margin:0 auto;">
          <div class="section-header">
            <div>
              <h2 style="margin:0; font-size: 28px; display:flex; align-items:center;">Marketing Center <span class="badge-pro">Premium</span></h2>
              <p style="color:#94a3b8; margin:6px 0 0 0;">G√©rez votre pr√©sence multi-canal et vos automatisations</p>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="mk-share-native" class="act-btn" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border:none;">
                    <span style="margin-right:6px;">‚ÜóÔ∏è</span> Partager
                </button>
                <button id="mk-fire" class="act-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626); border:none;">Publier Maintenant</button>
            </div>
          </div>

          <!-- Configuration Globale -->
          <div class="admin-card">
            <h3 style="margin-top:0; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:12px; margin-bottom:16px; color:#c4b5fd;">Configuration G√©n√©rale</h3>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:16px;">
                <div>
                    <label style="display:block; color:#94a3b8; font-size:12px; margin-bottom:6px; font-weight:600;">TEMPLATE DU MESSAGE</label>
                    <input id="mk-template" class="premium-input" placeholder="SurfSense: conditions live sur {spot} ‚Ä¢ {desc} #surf" />
                </div>
                <div>
                    <label style="display:block; color:#94a3b8; font-size:12px; margin-bottom:6px; font-weight:600;">INTERVALLE (MINUTES)</label>
                    <input id="mk-interval" type="number" min="1" class="premium-input" placeholder="60" />
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="display:block; color:#94a3b8; font-size:12px; margin-bottom:6px; font-weight:600;">WEBHOOK AGR√âGATEUR (LOGS/DEBUG)</label>
                    <input id="mk-webhook" class="premium-input" placeholder="https://discord.com/api/webhooks/..." />
                </div>
                 <!-- Hidden old Select used for compat if needed, or we just ignore it as we have per-channel formats now -->
                <select id="mk-type" style="display:none;"><option value="story">Story</option></select>
            </div>
          </div>

          <!-- Robot Automation Section -->
          <div class="admin-card" style="margin-top: 24px; border: 1px solid rgba(34, 197, 94, 0.3); background: rgba(34, 197, 94, 0.05);">
            <div style="display: flex; align-items: flex-start; gap: 16px;">
                <div style="font-size: 32px;">ü§ñ</div>
                <div>
                    <h3 style="margin: 0 0 8px 0; color: #4ade80;">Mode Robot Viral Activ√©</h3>
                    <p style="margin: 0 0 12px 0; color: #bbf7d0; font-size: 14px; line-height: 1.5;">
                        Le moteur viral est actif : il g√©n√®re automatiquement des accroches percutantes et des hashtags tendances.
                        <br><br>
                        <strong>‚ö†Ô∏è Important : S√©curit√©</strong><br>
                        Je suis une IA int√©gr√©e √† votre code, je n'ai pas de navigateur web. <strong>Je ne peux techniquement pas me connecter √† votre compte Make avec vos identifiants</strong> (c'est une s√©curit√© inviolable).
                        <br><br>
                        Mais c'est tr√®s simple, suivez ce guide de 2 minutes :
                    </p>
                    <button onclick="document.getElementById('robot-modal').style.display='flex'" class="act-btn" style="background: #22c55e; border-color: #16a34a;">
                        üõ†Ô∏è Finaliser la connexion (Make)
                    </button>
                </div>
            </div>
          </div>

          <!-- Modal Guide -->
          <div id="robot-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; justify-content:center; align-items:center;">
            <div style="background:#111827; width:650px; max-width:90%; padding:30px; border-radius:16px; border:1px solid #374151; max-height:90vh; overflow-y:auto;">
                <h2 style="margin-top:0; color:#4ade80;">ü§ñ Configuration Facile (Sans fichier)</h2>
                <p style="color:#e5e7eb;">Le fichier Blueprint pose probl√®me ? <strong>Faisons-le √† la main, c'est plus simple et √ßa prend 30 secondes.</strong></p>
                
                <div style="background:#1f2937; padding:20px; border-radius:12px; margin-bottom:20px;">
                    <h3 style="color:#4ade80; margin-top:0;">‚ú® Mode Direct Activ√©</h3>
                    <p style="color:#e5e7eb; line-height:1.6;">
                        Excellente nouvelle ! Nous avons activ√© le <strong>Mode Direct</strong> pour Instagram.
                    </p>
                    <ul style="color:#e5e7eb; line-height:1.6;">
                        <li>‚úÖ Plus besoin de Make pour Instagram</li>
                        <li>‚úÖ Plus besoin de Webhook</li>
                        <li>‚úÖ Publication instantan√©e et directe</li>
                    </ul>
                    <p style="color:#9ca3af; font-size:14px; margin-top:15px;">
                        Le syst√®me utilise maintenant une connexion directe s√©curis√©e via le serveur. Vous n'avez rien √† configurer.
                        Assurez-vous simplement que le champ "Webhook URL" d'Instagram est vide.
                    </p>
                </div>

                <div style="background:rgba(239, 68, 68, 0.1); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid rgba(239, 68, 68, 0.2);">
                    <h3 style="color:#f87171; margin-top:0;">Pour les autres r√©seaux (Optionnel)</h3>
                    <p style="color:#e5e7eb; font-size:14px;">
                        Si vous souhaitez activer Facebook, Twitter ou TikTok, vous pouvez toujours utiliser les Webhooks classiques via Make.
                        Mais pour Instagram, c'est r√©gl√© ! üöÄ
                    </p>
                </div>

                <div style="text-align:right; margin-top:20px;">
                    <button onclick="document.getElementById('robot-modal').style.display='none'" class="act-btn">C'est bon, √ßa marche !</button>
                </div>
            </div>
          </div>

          <!-- Grille des R√©seaux -->
          <h3 style="margin: 24px 0 12px 0; color:#c4b5fd; font-size: 18px;">Canaux de Diffusion</h3>
          <div class="premium-grid">
            
            <!-- Instagram -->
            <div class="net-card">
                <div class="net-header">
                    <div class="net-title">üì∏ Instagram</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mk-ch-instagram">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="net-body">
                    <div>
                        <label style="font-size:11px; color:#94a3b8; font-weight:600;">FORMAT</label>
                        <select id="mk-fmt-instagram" class="premium-input premium-select">
                            <option value="story">Story (9:16)</option>
                            <option value="post">Post (4:5)</option>
                            <option value="square">Post Carr√© (1:1)</option>
                            <option value="reel">Reel (9:16)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            <input id="mk-pf-instagram" class="premium-input" placeholder="URL Profil" style="font-size:11px;">
                            <input id="mk-wh-instagram" class="premium-input" placeholder="Laisser vide pour Mode Direct (Recommand√©)" style="font-size:11px;">
                            <div style="font-size:10px; color:#4ade80; margin-top:4px;">‚ú® Mode Direct Actif : Connexion serveur utilis√©e</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Facebook -->
            <div class="net-card">
                <div class="net-header">
                    <div class="net-title">üìò Facebook</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mk-ch-facebook">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="net-body">
                    <div>
                        <label style="font-size:11px; color:#94a3b8; font-weight:600;">FORMAT</label>
                        <select id="mk-fmt-facebook" class="premium-input premium-select">
                            <option value="post">Post (4:5)</option>
                            <option value="square">Post Carr√© (1:1)</option>
                            <option value="story">Story (9:16)</option>
                            <option value="reel">Reel (9:16)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            <input id="mk-pf-facebook" class="premium-input" placeholder="URL Profil" style="font-size:11px;">
                            <input id="mk-wh-facebook" class="premium-input" placeholder="Webhook URL" style="font-size:11px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TikTok -->
            <div class="net-card">
                <div class="net-header">
                    <div class="net-title">üéµ TikTok</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mk-ch-tiktok">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="net-body">
                    <div>
                        <label style="font-size:11px; color:#94a3b8; font-weight:600;">FORMAT</label>
                        <select id="mk-fmt-tiktok" class="premium-input premium-select">
                            <option value="video">Vid√©o (9:16)</option>
                            <option value="photo">Mode Photo (9:16)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            <input id="mk-pf-tiktok" class="premium-input" placeholder="URL Profil" style="font-size:11px;">
                            <input id="mk-wh-tiktok" class="premium-input" placeholder="Webhook URL" style="font-size:11px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Threads -->
            <div class="net-card">
                <div class="net-header">
                    <div class="net-title">üßµ Threads</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mk-ch-threads">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="net-body">
                    <div>
                        <label style="font-size:11px; color:#94a3b8; font-weight:600;">FORMAT</label>
                        <select id="mk-fmt-threads" class="premium-input premium-select">
                            <option value="post">Post (4:5)</option>
                            <option value="square">Post Carr√© (1:1)</option>
                            <option value="vertical">Vertical (9:16)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            <input id="mk-pf-threads" class="premium-input" placeholder="URL Profil" style="font-size:11px;">
                            <input id="mk-wh-threads" class="premium-input" placeholder="Webhook URL" style="font-size:11px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- YouTube -->
            <div class="net-card">
                <div class="net-header">
                    <div class="net-title">‚ñ∂Ô∏è YouTube</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mk-ch-youtube">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="net-body">
                    <div>
                        <label style="font-size:11px; color:#94a3b8; font-weight:600;">FORMAT</label>
                        <select id="mk-fmt-youtube" class="premium-input premium-select">
                            <option value="video">Vid√©o Longue (16:9)</option>
                            <option value="short">Short (9:16)</option>
                            <option value="community">Post Communaut√© (1:1)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            <input id="mk-pf-youtube" class="premium-input" placeholder="URL Profil" style="font-size:11px;">
                            <input id="mk-wh-youtube" class="premium-input" placeholder="Webhook URL" style="font-size:11px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- X/Twitter -->
            <div class="net-card">
                <div class="net-header">
                    <div class="net-title">‚úñÔ∏è X / Twitter</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mk-ch-twitter">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="net-body">
                    <div>
                        <label style="font-size:11px; color:#94a3b8; font-weight:600;">FORMAT</label>
                        <select id="mk-fmt-twitter" class="premium-input premium-select">
                            <option value="post">Post (16:9)</option>
                            <option value="square">Carr√© (1:1)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            <input id="mk-pf-twitter" class="premium-input" placeholder="URL Profil" style="font-size:11px;">
                            <input id="mk-wh-twitter" class="premium-input" placeholder="Webhook URL" style="font-size:11px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Telegram -->
            <div class="net-card">
                <div class="net-header">
                    <div class="net-title">‚úàÔ∏è Telegram</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mk-ch-telegram">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="net-body">
                    <div>
                        <label style="font-size:11px; color:#94a3b8; font-weight:600;">FORMAT</label>
                        <select id="mk-fmt-telegram" class="premium-input premium-select">
                            <option value="post">Fichier (Original)</option>
                            <option value="bulle">Bulle Vid√©o (1:1)</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            <input id="mk-pf-telegram" class="premium-input" placeholder="URL Profil" style="font-size:11px;">
                            <input id="mk-wh-telegram" class="premium-input" placeholder="Webhook URL" style="font-size:11px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discord -->
            <div class="net-card">
                <div class="net-header">
                    <div class="net-title">üëæ Discord</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mk-ch-discord">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="net-body">
                    <div>
                        <label style="font-size:11px; color:#94a3b8; font-weight:600;">FORMAT</label>
                        <select id="mk-fmt-discord" class="premium-input premium-select">
                            <option value="message">Message (Flexible)</option>
                            <option value="everyone">@everyone</option>
                            <option value="annonce">Annonce</option>
                        </select>
                    </div>
                    <div class="details-trigger" onclick="this.nextElementSibling.classList.toggle('open')">Configuration avanc√©e ‚ñº</div>
                    <div class="collapsible">
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            <input id="mk-pf-discord" class="premium-input" placeholder="URL Profil" style="font-size:11px;">
                            <input id="mk-wh-discord" class="premium-input" placeholder="Webhook URL" style="font-size:11px;">
                        </div>
                    </div>
                </div>
            </div>

          </div>

          <!-- Actions Footer -->
          <div class="admin-card" style="margin-top:24px; display:flex; justify-content:space-between; align-items:center;">
             <div style="display:flex; gap:12px; align-items:center;">
                <button id="mk-save" class="act-btn" style="background:#2563eb; border:none; padding:10px 24px;">ENREGISTRER</button>
                <div style="height:24px; width:1px; background:#1f2937; margin:0 8px;"></div>
                <button id="mk-start" class="act-btn">‚ñ∂ D√©marrer Auto</button>
                <button id="mk-stop" class="act-btn">‚èπ Stop</button>
                <span id="mk-status" style="color:#94a3b8; font-size:13px; margin-left:12px;">Status: -</span>
             </div>
             
             <div>
                 <a id="mk-email-link" href="#" style="color:#64748b; font-size:12px; text-decoration:none;">Support: <span id="mk-email-text">swellsync@outlook.fr</span></a>
                 <button id="mk-email-copy" style="background:none; border:none; color:#4b5563; cursor:pointer; font-size:12px;">(Copier)</button>
             </div>
          </div>
          
          <div style="margin-top:12px; text-align:right;">
             <button id="mk-agg-status" style="background:none; border:none; color:#4b5563; font-size:11px; cursor:pointer;">Logs Syst√®me</button>
             <div id="agg-out" style="margin-top:8px; color:#64748b; font-size:11px; font-family:monospace;"></div>
          </div>

        </div>
      </main>
    </div>
    <script>
      (function(){
        fetch("/admin/nav.html").then(r=>r.text()).then(html=>{ const el=document.getElementById("admin-nav"); if(el) el.innerHTML=html; }).catch(()=>{});
        const params = new URLSearchParams(window.location.search);
        const tParam = params.get("token");
        if (tParam) { try { localStorage.setItem("surfAdminToken", tParam); history.replaceState({}, "", window.location.pathname); } catch {} }
        const tok = localStorage.getItem("surfAdminToken") || "";
        const headers = tok ? { "x-admin-token": tok } : {};
        const q = (id) => document.getElementById(id);
        
        // Native Share Logic
        if (q("mk-share-native")) {
            q("mk-share-native").onclick = async () => {
                const tmpl = q("mk-template").value;
                const url = window.location.origin;
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'SurfSense Live',
                            text: tmpl.replace('{spot}', 'Spot').replace('{desc}', 'Conditions...'),
                            url: url
                        });
                    } catch (err) { console.log('Share canceled', err); }
                } else {
                    alert("Le partage n'est pas support√© sur ce navigateur.");
                }
            };
        }

        async function loadMarketing() {
          try {
            const r = await fetch("/api/admin/marketing/status", { headers });
            const s = await r.json();
            q("mk-status").textContent = "Status: "+(s.running ? "RUNNING" : "STOPPED")+" ‚Ä¢ "+(s.intervalMinutes||"-")+" min";
          } catch {}
          try {
            const rr = await fetch("/api/admin/marketing/config", { headers });
            const c = await rr.json();
            q("mk-webhook").value = c.webhookUrl || "";
            q("mk-interval").value = c.intervalMinutes || "";
            q("mk-template").value = c.template || "";
            q("mk-type").value = c.contentType || "story";
            const chs = new Set(c.channels || []);
            q("mk-ch-instagram").checked = chs.has("instagram");
            q("mk-ch-facebook").checked = chs.has("facebook");
            q("mk-ch-tiktok").checked = chs.has("tiktok");
            q("mk-ch-threads").checked = chs.has("threads");
            q("mk-ch-youtube").checked = chs.has("youtube");
            q("mk-ch-twitter").checked = chs.has("twitter");
            q("mk-ch-telegram").checked = chs.has("telegram");
            q("mk-ch-discord").checked = chs.has("discord");
            const cx = c.connectors || {};
            q("mk-wh-instagram").value = cx.instagram?.webhook || "";
            q("mk-wh-facebook").value = cx.facebook?.webhook || "";
            q("mk-wh-tiktok").value = cx.tiktok?.webhook || "";
            q("mk-wh-threads").value = cx.threads?.webhook || "";
            q("mk-wh-youtube").value = cx.youtube?.webhook || "";
            q("mk-wh-twitter").value = cx.twitter?.webhook || "";
            q("mk-wh-telegram").value = cx.telegram?.webhook || "";
            q("mk-wh-discord").value = cx.discord?.webhook || "";
            
            if (cx.instagram?.format) q("mk-fmt-instagram").value = cx.instagram.format;
            if (cx.facebook?.format) q("mk-fmt-facebook").value = cx.facebook.format;
            if (cx.tiktok?.format) q("mk-fmt-tiktok").value = cx.tiktok.format;
            if (cx.threads?.format) q("mk-fmt-threads").value = cx.threads.format;
            if (cx.youtube?.format) q("mk-fmt-youtube").value = cx.youtube.format;
            if (cx.twitter?.format) q("mk-fmt-twitter").value = cx.twitter.format;
            if (cx.telegram?.format) q("mk-fmt-telegram").value = cx.telegram.format;
            if (cx.discord?.format) q("mk-fmt-discord").value = cx.discord.format;

            q("mk-pf-instagram").value = cx.instagram?.profileUrl || "";
            q("mk-pf-facebook").value = cx.facebook?.profileUrl || "";
            q("mk-pf-tiktok").value = cx.tiktok?.profileUrl || "";
            q("mk-pf-threads").value = cx.threads?.profileUrl || "";
            q("mk-pf-youtube").value = cx.youtube?.profileUrl || "";
            q("mk-pf-twitter").value = cx.twitter?.profileUrl || "";
            q("mk-pf-telegram").value = cx.telegram?.profileUrl || "";
            q("mk-pf-discord").value = cx.discord?.profileUrl || "";
            const em = c.email || "swellsync@outlook.fr";
            q("mk-email-text").textContent = em;
            q("mk-email-link").href = "mailto:"+em;
          } catch {}
        }
        q("mk-email-copy").onclick = async () => {
          try {
            await navigator.clipboard.writeText(q("mk-email-text").textContent.trim());
            alert("Adresse copi√©e");
          } catch {}
        };
        q("mk-save").onclick = async () => {
          const channels = [];
          if (q("mk-ch-instagram").checked) channels.push("instagram");
          if (q("mk-ch-facebook").checked) channels.push("facebook");
          if (q("mk-ch-tiktok").checked) channels.push("tiktok");
          if (q("mk-ch-threads").checked) channels.push("threads");
          if (q("mk-ch-youtube").checked) channels.push("youtube");
          if (q("mk-ch-twitter").checked) channels.push("twitter");
          if (q("mk-ch-telegram").checked) channels.push("telegram");
          if (q("mk-ch-discord").checked) channels.push("discord");
          const connectors = {
            instagram: { enabled: q("mk-ch-instagram").checked, webhook: q("mk-wh-instagram").value.trim(), profileUrl: q("mk-pf-instagram").value.trim(), format: q("mk-fmt-instagram").value },
            facebook: { enabled: q("mk-ch-facebook").checked, webhook: q("mk-wh-facebook").value.trim(), profileUrl: q("mk-pf-facebook").value.trim(), format: q("mk-fmt-facebook").value },
            tiktok: { enabled: q("mk-ch-tiktok").checked, webhook: q("mk-wh-tiktok").value.trim(), profileUrl: q("mk-pf-tiktok").value.trim(), format: q("mk-fmt-tiktok").value },
            threads: { enabled: q("mk-ch-threads").checked, webhook: q("mk-wh-threads").value.trim(), profileUrl: q("mk-pf-threads").value.trim(), format: q("mk-fmt-threads").value },
            youtube: { enabled: q("mk-ch-youtube").checked, webhook: q("mk-wh-youtube").value.trim(), profileUrl: q("mk-pf-youtube").value.trim(), format: q("mk-fmt-youtube").value },
            twitter: { enabled: q("mk-ch-twitter").checked, webhook: q("mk-wh-twitter").value.trim(), profileUrl: q("mk-pf-twitter").value.trim(), format: q("mk-fmt-twitter").value },
            telegram: { enabled: q("mk-ch-telegram").checked, webhook: q("mk-wh-telegram").value.trim(), profileUrl: q("mk-pf-telegram").value.trim(), format: q("mk-fmt-telegram").value },
            discord: { enabled: q("mk-ch-discord").checked, webhook: q("mk-wh-discord").value.trim(), profileUrl: q("mk-pf-discord").value.trim(), format: q("mk-fmt-discord").value }
          };
          try {
            const rr = await fetch("/api/admin/marketing/config", {
              method: "POST",
              headers: { ...headers, "Content-Type":"application/json" },
              body: JSON.stringify({
                channels,
                webhookUrl: q("mk-webhook").value.trim(),
                template: q("mk-template").value,
                contentType: q("mk-type").value,
                connectors
              })
            });
            const dj = await rr.json();
            if (!rr.ok || !dj.success) { alert("Erreur configuration"); return; }
            loadMarketing();
          } catch { alert("Erreur configuration"); }
        };
        q("mk-fire").onclick = async () => {
          try {
            const rr = await fetch("/api/admin/marketing/fire", { method: "POST", headers });
            const dj = await rr.json();
            if (!rr.ok || !dj.success) { alert("Erreur publication"); return; }
            alert("Publication envoy√©e");
          } catch { alert("Erreur publication"); }
        };
        q("mk-start").onclick = async () => {
          const iv = parseInt(q("mk-interval").value, 10) || 60;
          try {
            const rr = await fetch("/api/admin/marketing/start", {
              method: "POST",
              headers: { ...headers, "Content-Type":"application/json" },
              body: JSON.stringify({ intervalMinutes: iv })
            });
            const dj = await rr.json();
            if (!rr.ok || !dj.success) { alert("Erreur d√©marrage"); return; }
            loadMarketing();
          } catch { alert("Erreur d√©marrage"); }
        };
        q("mk-stop").onclick = async () => {
          try {
            const rr = await fetch("/api/admin/marketing/stop", { method: "POST", headers });
            const dj = await rr.json();
            if (!rr.ok || !dj.success) { alert("Erreur stop"); return; }
            loadMarketing();
          } catch { alert("Erreur stop"); }
        };
        if(q("mk-test-fire")) {
            q("mk-test-fire").onclick = async () => {
                try {
                    const rr = await fetch("/api/admin/marketing/fire?test=true", { method: "POST", headers });
                    const dj = await rr.json();
                    if (!rr.ok || !dj.success) { alert("Erreur test"); return; }
                    alert("Test envoy√© ! Regardez sur Make (la bulle du Webhook doit bouger)");
                } catch { alert("Erreur test"); }
            };
        }
        q("mk-agg-status").onclick = async () => {
          try {
            const r = await fetch("/api/admin/agg/status", { headers });
            const j = await r.json();
            q("agg-out").textContent = "Interne: "+(j.internal?"oui":"non")+" ‚Ä¢ livraisons: "+(j.deliveries?.length||0)+" ‚Ä¢ en attente: "+(j.queued||0);
          } catch {
            q("agg-out").textContent = "Erreur agr√©gateur";
          }
        };
        loadMarketing();
      })();
    </script>
  </body>
</html>
