<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin ‚Äî SwellSync</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" href="../logo.svg" type="image/svg+xml" />
    <style>
      .admin-layout{display:flex;min-height:100vh}
      .admin-sidebar{width:260px;background:#0b0e16;border-right:1px solid #1f2937;padding:18px;position:sticky;top:0;height:100vh;backdrop-filter:blur(8px)}
      .admin-brand{display:flex;align-items:center;gap:10px;color:#e5e7eb;font-weight:800;margin-bottom:18px}
      .admin-nav a{display:block;padding:10px 12px;border-radius:12px;color:#c4b5fd;text-decoration:none;margin-bottom:6px;transition:background .2s, transform .1s}
      .admin-nav a:hover{background:#111827;transform:translateX(2px)}
      .admin-main{flex:1;padding:24px;background:
        radial-gradient(1200px 600px at -10% -10%, rgba(124,58,237,.12), transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, rgba(34,197,94,.12), transparent 60%)}
      .section-title h2{background:linear-gradient(90deg,#7c3aed,#22c55e,#f59e0b,#d946ef);background-size:300% 100%;-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-weight:900;animation:gradientShift 12s ease infinite}
      .forecast-title{color:#c4b5fd;font-weight:800}
      .btn.btn--compact{padding:6px 10px}
      .admin-cards{margin-top:20px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
      .admin-card{background:rgba(11,14,22,.7);backdrop-filter:blur(8px);border:1px solid #1f2937;border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.35);transition:transform .2s, box-shadow .2s}
      .admin-card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.45)}
      .metric-label{color:#94a3b8;font-weight:700}
      .metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
      .metric-value{color:#e5e7eb;font-weight:900;font-size:1.05rem}
      .stats-grid-6{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px;margin-top:20px}
      .stat-item{background:#0b0e16;border:1px solid #1f2937;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:6px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
      .stat-label{color:#94a3b8;font-weight:700;display:flex;align-items:center;gap:8px}
      .stat-icon{opacity:.9}
      .stat-value{color:#fff;font-weight:900;font-size:1.3rem}
      .pulse-dot{width:8px;height:8px;border-radius:50%;display:inline-block;animation:pulse 1.2s infinite}
      .sparkline{width:100%;height:40px;opacity:.9}
      .progress{height:10px;border-radius:8px;background:#111827;margin-top:10px;overflow:hidden}
      .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#d946ef,#f59e0b,#22c55e);transition:width .4s ease}
      .flash{animation:flash .6s}
      .live-toggle{display:flex;align-items:center;gap:10px;color:#94a3b8}
      .live-toggle input{appearance:none;width:38px;height:20px;border-radius:10px;background:#1f2937;position:relative;outline:none;transition:background .2s}
      .live-toggle input::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:left .2s}
      .live-toggle input:checked{background:#22c55e}
      .live-toggle input:checked::after{left:20px}
      .theme-toggle{display:flex;align-items:center;gap:10px;color:#94a3b8}
      .theme-toggle input{appearance:none;width:38px;height:20px;border-radius:10px;background:#1f2937;position:relative;outline:none;transition:background .2s}
      .theme-toggle input::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:left .2s}
      .theme-toggle input:checked{background:#d946ef}
      .theme-toggle input:checked::after{left:20px}
      .neon .admin-card{box-shadow:0 8px 34px rgba(217,70,239,.25), inset 0 0 0 1px rgba(217,70,239,.12)}
      .neon .stat-item{box-shadow:0 6px 28px rgba(96,165,250,.25)}
      .neon .admin-main{background:
        radial-gradient(1200px 600px at -10% -10%, rgba(217,70,239,.16), transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, rgba(245,158,11,.14), transparent 60%)}
      @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
      @keyframes pulse{0%{transform:scale(1);opacity:.9}50%{transform:scale(1.4);opacity:.6}100%{transform:scale(1);opacity:.9}}
      @keyframes flash{0%{box-shadow:0 0 0 rgba(124,58,237,0)}50%{box-shadow:0 0 18px rgba(124,58,237,.35)}100%{box-shadow:0 0 0 rgba(124,58,237,0)}}
    </style>
  </head>
  <body style="background:#080a12;">
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div class="admin-brand">
          <img src="../logo.svg" alt="logo" width="24" height="24"/>
          <span>Admin</span>
        </div>
        <nav class="admin-nav">
          <a href="#overview">Overview</a>
          <a href="#analytics">Analytique</a>
          <a href="#robots">Robots</a>
          <a href="#actions">Actions</a>
          <a href="#spots">Spots</a>
          <a href="#logs">Logs</a>
          <a href="#users">Utilisateurs</a>
          <a href="#regions">R√©gions</a>
        </nav>
      </aside>
      <main class="admin-main">
    <div class="section" style="max-width:1200px; margin:0 auto;">
      <div class="section-title" id="overview" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2>Tableau de bord Admin</h2>
          <p style="color:#94a3b8;">Surveillance en temps r√©el</p>
        </div>
        <div style="display:flex; align-items:center; gap:14px;">
          <span class="badge badge--live">LIVE</span>
          <label class="live-toggle"><input type="checkbox" id="live-mode"><span>Live mode</span></label>
          <button id="pause-live" class="btn btn--compact">Pause Live</button>
          <label class="theme-toggle"><input type="checkbox" id="dark-neon"><span>Dark Neon</span></label>
        </div>
      </div>
      <div class="admin-cards">
        <div class="admin-card" id="card-health">
          <div class="metric-label">Sant√© Syst√®me</div>
          <div class="metric-grid">
            <div style="color:#9ca3af">DB</div><div id="health-db" class="metric-value">-</div>
            <div style="color:#9ca3af">Ping DB</div><div id="health-ping" class="metric-value">-</div>
            <div style="color:#9ca3af">Uptime</div><div id="health-uptime" class="metric-value">-</div>
            <div style="color:#9ca3af">M√©moire</div><div id="health-mem" class="metric-value">-</div>
            <div style="color:#9ca3af">Cache</div><div id="health-cache" class="metric-value">-</div>
            <div style="color:#9ca3af">API</div><div id="health-api" class="metric-value">-</div>
            <div style="color:#9ca3af">Spots</div><div id="health-spots" class="metric-value">-</div>
          </div>
        </div>
        <div class="admin-card" id="card-workers">
          <div class="metric-label">Workers</div>
          <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
            <span class="pulse-dot" style="background:#22c55e"></span>
            <button id="btn-worker-pause" class="btn btn--compact">Pause</button>
            <button id="btn-worker-resume" class="btn btn--compact">Resume</button>
            <input id="worker-interval" type="number" min="1" max="240" value="45" class="btn" style="width:90px;"/>
            <button id="btn-worker-apply" class="btn btn--compact">Appliquer</button>
          </div>
          <div style="color:#9ca3af; margin-top:6px;">Intervalle actuel: <span id="worker-interval-cur" class="metric-value">-</span> min ¬∑ √âtat: <span id="worker-state" class="metric-value">-</span></div>
        </div>
        <div class="admin-card" id="card-quota">
          <div class="metric-label">Quota API</div>
          <div class="metric-grid">
            <div style="color:#9ca3af">Limite</div><div id="health-limit" class="metric-value">-</div>
            <div style="color:#9ca3af">Restant</div><div id="health-rem" class="metric-value">-</div>
            <div style="color:#9ca3af">Utilis√©</div><div id="health-used" class="metric-value">-</div>
          </div>
          <div class="progress"><div id="quota-progress-bar" class="progress-bar"></div></div>
          <div style="margin-top:10px;">
            <button id="btn-quota-reel" class="btn btn--compact">Actualiser quota r√©el (Stormglass)</button>
            <div id="quota-source" style="color:#94a3b8; margin-top:6px;"></div>
          </div>
        </div>
      </div>
      <div id="admin-grid" class="stats-grid-6">
        <div class="stat-item"><span class="stat-label"><span class="pulse-dot" style="background:#60a5fa"></span><span class="stat-icon">üë§</span> Utilisateurs</span><span class="stat-value"><span id="m-users">-</span></span><canvas id="spark-users" class="sparkline" width="140" height="40"></canvas></div>
        <div class="stat-item"><span class="stat-label"><span class="pulse-dot" style="background:#f59e0b"></span><span class="stat-icon">‚ô•</span> Favoris</span><span class="stat-value"><span id="m-favorites">-</span></span></div>
        <div class="stat-item"><span class="stat-label"><span class="pulse-dot" style="background:#94a3b8"></span><span class="stat-icon">üñ±Ô∏è</span> Clicks</span><span class="stat-value"><span id="m-clicks">-</span></span></div>
        <div class="stat-item"><span class="stat-label"><span class="pulse-dot" style="background:#22c55e"></span><span class="stat-icon">üõ∞Ô∏è</span> Spots LIVE</span><span class="stat-value"><span id="m-live">-</span></span><canvas id="spark-live" class="sparkline" width="140" height="40"></canvas></div>
        <div class="stat-item"><span class="stat-label"><span class="pulse-dot" style="background:#facc15"></span><span class="stat-icon">‚è≥</span> Spots WAIT</span><span class="stat-value"><span id="m-wait">-</span></span></div>
        <div class="stat-item"><span class="stat-label"><span class="pulse-dot" style="background:#d946ef"></span><span class="stat-icon">‚ö°</span> Alertes √âPIQUES</span><span class="stat-value"><span id="m-epic">-</span></span><canvas id="spark-epic" class="sparkline" width="140" height="40"></canvas></div>
      </div>
      <div class="stats-grid-6" style="margin-top:20px;">
        <div class="stat-item"><span class="stat-label"><span class="pulse-dot" style="background:#22c55e"></span><span class="stat-icon">üîë</span> Quota RESTANT</span><span class="stat-value"><span id="m-quota-rem">-</span></span><canvas id="spark-quota" class="sparkline" width="140" height="40"></canvas></div>
        <div class="stat-item"><span class="stat-label"><span class="stat-icon">üéöÔ∏è</span> Quota LIMITE</span><span class="stat-value"><span id="m-quota-limit">-</span></span></div>
        <div class="stat-item"><span class="stat-label"><span class="stat-icon">üìä</span> Quota UTILIS√â</span><span class="stat-value"><span id="m-quota-used">-</span></span></div>
        <div class="stat-item"><span class="stat-label"><span class="stat-icon">üóÑÔ∏è</span> Cache Items</span><span class="stat-value"><span id="m-cache">-</span></span></div>
        <div class="stat-item"><span class="stat-label"><span class="stat-icon">üåä</span> Tide Keys</span><span class="stat-value"><span id="m-tide">-</span></span></div>
      </div>
      <div id="analytics" style="margin-top:30px;">
        <h3 class="forecast-title">Analytique</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
          <div class="admin-card">
            <div style="color:#94a3b8; margin-bottom:8px;">Spots LIVE vs WAIT (24h)</div>
            <canvas id="chart-live" width="520" height="180"></canvas>
          </div>
          <div class="admin-card">
            <div style="color:#94a3b8; margin-bottom:8px;">Quota restant (24h)</div>
            <canvas id="chart-quota" width="520" height="180"></canvas>
          </div>
          <div class="admin-card">
            <div style="color:#94a3b8; margin-bottom:8px;">Alertes √âPIQUES (24h)</div>
            <canvas id="chart-epic" width="520" height="180"></canvas>
          </div>
          <div class="admin-card">
            <div style="color:#94a3b8; margin-bottom:8px;">Utilisateurs (24h)</div>
            <canvas id="chart-users" width="520" height="180"></canvas>
          </div>
        </div>
      </div>
      <div id="robots" style="margin-top:30px;">
        <h3 class="forecast-title">Robots</h3>
        <div id="robots-list" class="robots-grid-container"></div>
      </div>
      <div id="actions" style="margin-top:30px;">
        <h3 class="forecast-title">Actions</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button id="btn-clear-cache" class="btn">Vider cache</button>
          <button id="btn-clear-tide" class="btn">Vider cache mar√©e</button>
          <button id="btn-reload-news" class="btn">Recharger actu</button>
          <button id="btn-snapshot-robots" class="btn">Snapshot robots</button>
        </div>
      </div>
      <div id="spots" style="margin-top:30px;">
        <h3 class="forecast-title">Tableau des spots</h3>
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
          <label style="color:#94a3b8;">R√©gion</label>
          <select id="region-filter" class="btn" style="background:#0b0e16; border:1px solid #1f2937; color:#e5e7eb;">
            <option value="">Toutes</option>
          </select>
          <button id="btn-export-spots" class="btn">Exporter CSV spots</button>
        </div>
        <div id="spots-list" style="display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px;"></div>
      </div>
      <div id="logs" style="margin-top:30px; display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div>
          <h3 class="forecast-title">Logs r√©cents</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="logs-start" type="date" class="btn" />
              <input id="logs-end" type="date" class="btn" />
              <button id="btn-apply-logs" class="btn btn--compact">Appliquer</button>
            </div>
            <button id="btn-export-logs" class="btn">Exporter CSV logs</button>
          </div>
          <div id="logs-list" style="background:#0b0e16; border:1px solid #1f2937; border-radius:12px; padding:12px; max-height:320px; overflow:auto;"></div>
        </div>
        <div id="users">
          <h3 class="forecast-title">Utilisateurs r√©cents</h3>
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <input id="user-search" class="btn" placeholder="Rechercher email" style="flex:1; background:#0b0e16; border:1px solid #1f2937; color:#e5e7eb;"/>
            <select id="user-type-filter" class="btn" style="background:#0b0e16; border:1px solid #1f2937; color:#e5e7eb;">
              <option value="">Tous</option>
              <option value="premium">Premium</option>
              <option value="standard">Standard</option>
            </select>
            <button id="btn-reset-premium" class="btn">Enlever Premium (tous)</button>
            <button id="btn-export-users" class="btn">Exporter CSV</button>
          </div>
          <div style="color:#94a3b8; margin-bottom:8px;">Supprim√©s aujourd‚Äôhui: <span id="deleted-today">0</span></div>
          <div id="users-list" style="background:#0b0e16; border:1px solid #1f2937; border-radius:12px; padding:12px; max-height:320px; overflow:auto;"></div>
        </div>
      </div>
      <div id="regions" style="margin-top:30px;">
        <h3 class="forecast-title">Sessions par r√©gion (7 jours)</h3>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input id="regions-start" type="date" class="btn" />
          <input id="regions-end" type="date" class="btn" />
          <button id="btn-apply-regions" class="btn btn--compact">Appliquer</button>
        </div>
        <div id="regions-bars" style="background:#0b0e16; border:1px solid #1f2937; border-radius:12px; padding:12px;"></div>
      </div>
    </div>
    <script>
      (function(){
        const params = new URLSearchParams(window.location.search);
        const tParam = params.get("token");
        if (tParam) { try { localStorage.setItem("surfAdminToken", tParam); history.replaceState({}, "", window.location.pathname); } catch {} }
        const tok = localStorage.getItem("surfAdminToken") || "";
        const headers = tok ? { "x-admin-token": tok } : {};
        const q = (id) => document.getElementById(id);
        const toast = (msg, type="success") => {
          const el = document.createElement("div");
          el.textContent = msg;
          el.style.position = "fixed";
          el.style.right = "16px";
          el.style.bottom = "16px";
          el.style.background = type === "error" ? "#ef4444" : "#22c55e";
          el.style.color = "#fff";
          el.style.padding = "10px 12px";
          el.style.borderRadius = "8px";
          el.style.boxShadow = "0 4px 24px rgba(0,0,0,0.35)";
          el.style.zIndex = "9999";
          el.style.fontWeight = "600";
          document.body.appendChild(el);
          setTimeout(() => { el.style.transition = "opacity .3s"; el.style.opacity = "0"; setTimeout(() => el.remove(), 300); }, 1800);
        };
        const drawLine = (canvas, points, color="#7c3aed") => {
          if (!canvas) return;
          const ctx = canvas.getContext("2d");
          const w = canvas.width, h = canvas.height;
          ctx.clearRect(0,0,w,h);
          const arr = points.slice(-50);
          if (!arr.length) return;
          const ys = arr.map(p => p.v);
          const min = Math.min.apply(null, ys);
          const max = Math.max.apply(null, ys);
          const pad = 10;
          const scaleY = (v) => {
            if (max === min) return h/2;
            return h - pad - ((v - min) / (max - min)) * (h - pad*2);
          };
          ctx.strokeStyle = "#1f2937"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke();
          ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
          arr.forEach((p,i) => {
            const x = pad + (i / Math.max(1, arr.length-1)) * (w - pad*2);
            const y = scaleY(p.v);
            if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          });
          ctx.stroke();
        };
        const animateNumber = (el, val) => {
          if (!el) return;
          const target = Number(val) || 0;
          const prev = Number(el.dataset.v || el.textContent || 0);
          const steps = 12;
          let i = 0;
          const d = (target - prev) / steps;
          el.classList.add("flash");
          const tick = () => {
            i++;
            const cur = Math.round(prev + d * i);
            el.textContent = String(cur);
            if (i < steps) { requestAnimationFrame(tick); } else { el.textContent = String(target); el.dataset.v = String(target); el.classList.remove("flash"); }
          };
          tick();
        };
        const drawBars = (container, data) => {
          if (!container) return;
          container.innerHTML = Object.entries(data).sort((a,b)=>b[1]-a[1]).map(([k,v]) => {
            const pct = Math.min(100, Math.round(v * 3));
            return '<div style="display:flex; align-items:center; gap:10px; margin:6px 0;"><div style="width:160px; color:#e5e7eb;">'+k+'</div><div style="flex:1; background:#111827; border-radius:8px; overflow:hidden;"><div style="width:'+pct+'%; background:#7c3aed; height:16px;"></div></div><div style="width:60px; text-align:right; color:#94a3b8;">'+v+'</div></div>';
          }).join("");
        };
        let timers = {};
        let liveMode = false;
        let paused = false;
        const schedule = (fast) => {
          Object.values(timers).forEach(id => { try { clearInterval(id); } catch {} });
          timers = {};
          if (paused) return;
          if (fast) {
            timers.t1 = setInterval(load, 2000);
            timers.t2 = setInterval(loadHealth, 3000);
            timers.t3 = setInterval(loadAnalytics, 6000);
            timers.t4 = setInterval(loadRegions, 6000);
            timers.t5 = setInterval(loadSpots, 3000);
            timers.t6 = setInterval(loadLogs, 3000);
            timers.t7 = setInterval(loadUsers, 4000);
          } else {
            timers.t1 = setInterval(load, 5000);
            timers.t2 = setInterval(loadHealth, 8000);
            timers.t3 = setInterval(loadAnalytics, 15000);
            timers.t4 = setInterval(loadRegions, 15000);
            timers.t5 = setInterval(loadSpots, 6000);
            timers.t6 = setInterval(loadLogs, 7000);
            timers.t7 = setInterval(loadUsers, 9000);
          }
        };
        async function load() {
          try {
            const res = await fetch("/api/admin/metrics", { headers });
            const d = await res.json();
            if (!res.ok) { throw new Error(d.error || "Forbidden"); }
            animateNumber(q("m-users"), d.users);
            animateNumber(q("m-favorites"), d.favorites);
            animateNumber(q("m-clicks"), d.clicks);
            animateNumber(q("m-live"), d.liveSpots);
            animateNumber(q("m-wait"), d.waitingSpots);
            animateNumber(q("m-epic"), d.epicAlerts);
            animateNumber(q("m-quota-rem"), d.quota.remaining);
            animateNumber(q("m-quota-limit"), d.quota.limit);
            animateNumber(q("m-quota-used"), d.quota.used);
            animateNumber(q("m-cache"), d.cacheItems);
            animateNumber(q("m-tide"), d.tideKeys);
            const lim = d.quota.limit || 0;
            const used = d.quota.used || 0;
            const pct = lim > 0 ? Math.min(100, Math.round((used / lim) * 100)) : 0;
            const bar = document.getElementById("quota-progress-bar");
            if (bar) bar.style.width = pct + "%";
            q("deleted-today").textContent = d.deletedToday || 0;
            const robots = d.robotsStatus || {};
            const container = document.getElementById("robots-list");
            if (container) {
              const items = Object.entries(robots).map(([name, info]) => {
                const dot = info.status === "OK" ? "#4ade80" : "#facc15";
                return '<div class="ai-robot-card"><span class="robot-icon">'+(info.icon||"ü§ñ")+'</span><div class="robot-info"><span class="robot-name"><span class="status-dot" style="background:'+dot+'"></span>'+name+'</span><span class="robot-value">'+(info.status||"-")+'</span><span class="robot-desc">'+(info.details||"")+'</span></div></div>';
              }).join("");
              container.innerHTML = items;
            }
          } catch(e) {
            alert("Acc√®s refus√©. Veuillez vous reconnecter.");
            localStorage.removeItem("surfAdminToken");
            window.location.href = "../index.html";
          }
        }
        async function loadHealth() {
          try {
            const r = await fetch("/api/admin/health", { headers });
            const h = await r.json();
            document.getElementById("health-db").textContent = h.db ? "OK" : "ERREUR";
            document.getElementById("health-ping").textContent = (h.pingMs ?? "-")+" ms";
            document.getElementById("health-uptime").textContent = h.uptime+" s";
            document.getElementById("health-mem").textContent = h.memoryMB+" MB";
            document.getElementById("health-cache").textContent = h.cacheCount ?? "-";
            document.getElementById("health-api").textContent = (h.apiCallCount ?? 0)+" appels";
            document.getElementById("health-spots").textContent = "LIVE "+(h.live||0)+" ¬∑ WAIT "+(h.wait||0);
            document.getElementById("health-limit").textContent = h.quota?.limit ?? "-";
            document.getElementById("health-rem").textContent = h.quota?.remaining ?? "-";
            document.getElementById("health-used").textContent = h.quota?.used ?? "-";
            document.getElementById("worker-interval-cur").textContent = h.worker?.intervalMinutes ?? "-";
            document.getElementById("worker-state").textContent = h.worker?.paused ? "PAUSED" : "RUNNING";
            document.getElementById("worker-interval").value = h.worker?.intervalMinutes ?? 45;
          } catch {}
        }
        document.getElementById("btn-worker-pause").onclick = async () => {
          try { const r = await fetch("/api/admin/workers", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ action: "pause" }) }); if (r.ok) { toast("Worker en pause"); loadHealth(); } else { toast("Erreur pause", "error"); } } catch { toast("Erreur pause", "error"); }
        };
        document.getElementById("btn-worker-resume").onclick = async () => {
          try { const r = await fetch("/api/admin/workers", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ action: "resume" }) }); if (r.ok) { toast("Worker relanc√©"); loadHealth(); } else { toast("Erreur resume", "error"); } } catch { toast("Erreur resume", "error"); }
        };
        document.getElementById("btn-worker-apply").onclick = async () => {
          const minutes = parseInt(document.getElementById("worker-interval").value || "45");
          try { const r = await fetch("/api/admin/workers", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ action: "setInterval", minutes }) }); if (r.ok) { toast("Intervalle mis √† jour"); loadHealth(); } else { toast("Erreur intervalle", "error"); } } catch { toast("Erreur intervalle", "error"); }
        };
        document.getElementById("btn-quota-reel").onclick = async () => {
          const elSrc = document.getElementById("quota-source");
          try {
            elSrc.textContent = "Mise √† jour‚Ä¶";
            const r = await fetch("/api/admin/quota/reel", { headers });
            const dj = await r.json();
            if (!r.ok) { toast("Erreur quota r√©el", "error"); elSrc.textContent = ""; return; }
            document.getElementById("health-limit").textContent = dj.limit ?? "-";
            document.getElementById("health-rem").textContent = dj.remaining ?? "-";
            document.getElementById("health-used").textContent = dj.used ?? "-";
            elSrc.textContent = "Source: "+(dj.source === "dashboard" ? "Dashboard Stormglass" : "API Stormglass");
            toast("Quota r√©el mis √† jour");
          } catch { toast("Erreur quota r√©el", "error"); }
        };
        async function loadAnalytics() {
          try {
            const r = await fetch("/api/admin/analytics/timeseries", { headers });
            const series = await r.json();
            drawLine(document.getElementById("chart-live"), series.live, "#22c55e");
            drawLine(document.getElementById("chart-quota"), series.quota, "#f59e0b");
            drawLine(document.getElementById("chart-epic"), series.epic, "#d946ef");
            drawLine(document.getElementById("chart-users"), series.users, "#60a5fa");
            drawLine(document.getElementById("spark-live"), series.live, "#22c55e");
            drawLine(document.getElementById("spark-quota"), series.quota, "#f59e0b");
            drawLine(document.getElementById("spark-epic"), series.epic, "#d946ef");
            drawLine(document.getElementById("spark-users"), series.users, "#60a5fa");
          } catch {}
        }
        async function loadRegions() {
          try {
            const s = document.getElementById("regions-start").value;
            const e = document.getElementById("regions-end").value;
            let url = "/api/admin/regions";
            if (s && e) url = "/api/admin/regions?start="+encodeURIComponent(s)+"&end="+encodeURIComponent(e);
            const r = await fetch(url, { headers });
            const data = await r.json();
            drawBars(document.getElementById("regions-bars"), data);
          } catch {}
        }
        document.getElementById("btn-apply-regions").onclick = loadRegions;
        async function loadSpots() {
          try {
            const r = await fetch("/api/admin/spots", { headers });
            const arr = await r.json();
            const regions = Array.from(new Set(arr.map(x => x.region))).sort();
            const sel = document.getElementById("region-filter");
            if (sel && sel.options.length <= 1) {
              regions.forEach(reg => {
                const o = document.createElement("option");
                o.value = reg; o.textContent = reg; sel.appendChild(o);
              });
            }
            const filter = sel.value;
            const filtered = filter ? arr.filter(x => x.region === filter) : arr;
            const pr = await fetch("/api/admin/spots/priority", { headers }).then(r=>r.json()).catch(()=>[]);
            const m = (x) => {
              const dot = x.status === "LIVE" ? "#4ade80" : "#facc15";
              const h = x.waveHeight != null ? x.waveHeight.toFixed(1)+"m" : "-";
              const t = x.wavePeriod != null ? Math.round(x.wavePeriod)+"s" : "-";
              const v = x.windSpeed != null ? Math.round(x.windSpeed)+"km/h" : "-";
              const d = x.windDirection || "-";
              const time = x.sourceTime ? new Date(x.sourceTime).toLocaleTimeString() : "-";
              const star = Array.isArray(pr) && pr.includes(x.name) ? "‚òÖ" : "‚òÜ";
              return '<div class="ai-robot-card"><span class="robot-icon">üèÑ‚Äç‚ôÇÔ∏è</span><div class="robot-info"><span class="robot-name"><span class="status-dot" style="background:'+dot+'"></span>'+x.name+' ‚Äî '+x.region+'</span><span class="robot-value">H '+h+' ‚Ä¢ T '+t+' ‚Ä¢ V '+v+' '+d+'</span><span class="robot-desc">Maj '+time+'</span><div style="margin-top:8px; display:flex; gap:8px;"><button class="btn btn--compact" data-action="refresh" data-name="'+x.name+'">Forcer refresh</button><button class="btn btn--compact" data-action="clear" data-name="'+x.name+'">Effacer cache</button><button class="btn btn--compact" data-action="priority" data-name="'+x.name+'">'+star+' Priorit√©</button><button class="btn btn--compact" data-action="epic-add" data-name="'+x.name+'">Marquer EPIC</button><button class="btn btn--compact" data-action="epic-rem" data-name="'+x.name+'">Retirer EPIC</button></div></div></div>';
            };
            const container = document.getElementById("spots-list");
            container.innerHTML = filtered.map(m).join("");
            container.querySelectorAll("button[data-action]").forEach(btn => {
              btn.onclick = async () => {
                const name = btn.getAttribute("data-name");
                const action = btn.getAttribute("data-action");
                if (action === "refresh") {
                  await fetch("/api/admin/spots/refresh", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ name }) });
                  toast("Spot rafra√Æchi");
                } else if (action === "clear") {
                  await fetch("/api/admin/spots/clear", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ name }) });
                  toast("Cache spot effac√©");
                } else if (action === "priority") {
                  const rr = await fetch("/api/admin/spots/priority/toggle", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ name }) });
                  if (rr.ok) toast("Priorit√© mise √† jour"); else toast("Erreur priorit√©", "error");
                } else if (action === "epic-add") {
                  const rr = await fetch("/api/admin/alerts/manual", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ name, reason: "admin" }) });
                  if (rr.ok) toast("EPIC ajout√©"); else toast("Erreur EPIC", "error");
                } else if (action === "epic-rem") {
                  const rr = await fetch("/api/admin/alerts/manual/remove", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ name }) });
                  if (rr.ok) toast("EPIC retir√©"); else toast("Erreur EPIC", "error");
                }
                loadSpots();
              };
            });
          } catch {}
        }
        document.getElementById("region-filter").onchange = loadSpots;
        document.getElementById("btn-export-spots").onclick = async () => {
          try {
            const rr = await fetch("/api/admin/spots/export", { headers });
            if (!rr.ok) { toast("Erreur export spots", "error"); return; }
            const blob = await rr.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "spots.csv";
            document.body.appendChild(a); a.click();
            setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
            toast("CSV spots export√©");
          } catch { toast("Erreur export spots", "error"); }
        };
        async function loadLogs() {
          try {
            const s = document.getElementById("logs-start").value;
            const e = document.getElementById("logs-end").value;
            let url = "/api/admin/logs";
            if (s && e) url = "/api/admin/logs/range?start="+encodeURIComponent(s)+"&end="+encodeURIComponent(e);
            const r = await fetch(url, { headers });
            const arr = await r.json();
            const el = document.getElementById("logs-list");
            el.innerHTML = arr.map(x => '<div style="display:flex; justify-content:space-between; padding:6px 8px; border-bottom:1px solid #111827;"><span style="color:#9ca3af">'+(x.spot_name||"-")+'</span><span style="color:#6b7280">'+(x.ip||"-")+'</span></div>').join("");
          } catch {}
        }
        document.getElementById("btn-apply-logs").onclick = loadLogs;
        document.getElementById("btn-export-logs").onclick = async () => {
          try {
            const s = document.getElementById("logs-start").value;
            const e = document.getElementById("logs-end").value;
            let url = "/api/admin/logs/export";
            if (s && e) url = "/api/admin/logs/export?start="+encodeURIComponent(s)+"&end="+encodeURIComponent(e);
            const rr = await fetch(url, { headers });
            if (!rr.ok) { toast("Erreur export logs", "error"); return; }
            const blob = await rr.blob();
            const blobUrl = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = blobUrl; a.download = "logs.csv";
            document.body.appendChild(a); a.click();
            setTimeout(() => { URL.revokeObjectURL(blobUrl); a.remove(); }, 0);
            toast("CSV logs export√©");
          } catch { toast("Erreur export logs", "error"); }
        };
        let usersCache = [];
        async function loadUsers() {
          try {
            const r = await fetch("/api/admin/users/recent", { headers });
            const arr = await r.json();
            usersCache = arr;
            renderUsers();
          } catch {}
        }
        function renderUsers() {
          const el = document.getElementById("users-list");
          const type = document.getElementById("user-type-filter").value;
          const filtered = usersCache.filter(x => {
            if (type === "premium") return !!x.premium;
            if (type === "standard") return !x.premium;
            return true;
          });
          el.innerHTML = filtered.map(x => '<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border-bottom:1px solid #111827;"><div style="display:flex; gap:12px; align-items:center;"><span style="color:#9ca3af">'+(x.name||"Utilisateur")+'</span><span style="color:#6b7280">'+(x.email||"-")+'</span><span style="color:'+(x.premium?'#d946ef':'#94a3b8')+'">'+(x.premium?'Premium':'Standard')+'</span></div><div><button class="btn btn--compact" data-del="'+x.id+'">Supprimer</button></div></div>').join("");
          el.querySelectorAll("button[data-del]").forEach(btn => {
            btn.onclick = async () => {
              const uid = parseInt(btn.getAttribute("data-del"));
              if (!uid) return;
              if (!confirm("Supprimer cet utilisateur ?")) return;
              try {
                const rr = await fetch("/api/admin/users/delete", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ userId: uid }) });
                const dj = await rr.json();
                if (!rr.ok) { alert(dj.error || "Erreur suppression"); return; }
                loadUsers();
                load();
                toast("Utilisateur supprim√©");
              } catch { alert("Erreur suppression"); }
            };
          });
        }
        document.getElementById("user-type-filter").onchange = renderUsers;
        document.getElementById("user-search").onchange = async (e) => {
          const val = e.target.value.trim();
          if (!val) { loadUsers(); return; }
          try {
            const r = await fetch("/api/admin/users/search?email="+encodeURIComponent(val), { headers });
            usersCache = await r.json();
            renderUsers();
          } catch {}
        }
        document.getElementById("btn-reset-premium").onclick = async () => {
          if (!confirm("Enlever Premium √† tous les utilisateurs (sauf admin) ?")) return;
          try {
            const rr = await fetch("/api/admin/users/premium/reset", { method:"POST", headers });
            const dj = await rr.json();
            if (!rr.ok) { alert(dj.error || "Erreur"); return; }
            loadUsers();
            toast("Premium retir√©");
          } catch { alert("Erreur"); }
        };
        document.getElementById("btn-export-users").onclick = async () => {
          try {
            const rr = await fetch("/api/admin/users/export", { headers });
            if (!rr.ok) { toast("Erreur export", "error"); return; }
            const blob = await rr.blob();
            const blobUrl = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = blobUrl; a.download = "users.csv";
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { URL.revokeObjectURL(blobUrl); a.remove(); }, 0);
            toast("CSV export√©");
          } catch { toast("Erreur export", "error"); }
        };
        async function clearCache(type) {
          try {
            await fetch("/api/admin/cache/clear", { method:"POST", headers: { ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ type }) });
            load();
            toast(type==="tide"?"Cache mar√©e vid√©":"Cache vid√©");
          } catch {}
        }
        async function reloadNews() {
          try { await fetch("/api/admin/news/reload", { method:"POST", headers }); toast("Actu recharg√©e"); } catch {}
        }
        async function snapshotRobots() {
          try { await fetch("/api/admin/robots/snapshot", { method:"POST", headers }); load(); toast("Robots mis √† jour"); } catch {}
        }
        document.getElementById("btn-clear-cache").onclick = () => { if (confirm("Vider tout le cache ?")) clearCache("all"); };
        document.getElementById("btn-clear-tide").onclick = () => clearCache("tide");
        document.getElementById("btn-reload-news").onclick = reloadNews;
        document.getElementById("btn-snapshot-robots").onclick = snapshotRobots;
        load();
        loadHealth();
        loadAnalytics();
        loadRegions();
        loadSpots();
        loadLogs();
        loadUsers();
        schedule(false);
        document.getElementById("live-mode").onchange = (e) => { liveMode = !!e.target.checked; schedule(liveMode); };
        document.getElementById("pause-live").onclick = () => {
          paused = !paused;
          Object.values(timers).forEach(id => { try { clearInterval(id); } catch {} });
          timers = {};
          document.getElementById("pause-live").textContent = paused ? "Reprendre Live" : "Pause Live";
          if (!paused) schedule(liveMode);
        };
        document.getElementById("dark-neon").onchange = (e) => {
          const active = !!e.target.checked;
          document.body.classList.toggle("neon", active);
        };
      })();
    </script>
      </main>
    </div>
  </body>
</html>
